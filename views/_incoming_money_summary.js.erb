require(['jquery','charts','ysdtemplate'], function($, Chart, tmpl) {


  bookingIncomingModel = {

     result : null,

     graphData : { labels   : [] ,
                   datasets : [
                     { 
                  	   fillColor : "rgba(220, 220, 220, 0.5)",
			                 strokeColor : "rgba(220, 220, 220, 1)",
			                 pointColor : "rgba(220, 220, 220,1)",
			                 pointStrokeColor : "#fff",
			                 data : []
			              }] 
                },

     maxValue: function() {
        var max= 10;
        for (var property in this.result) {
          var total = new Number(this.result[property].total);
          if (total > max) {
            max = total;
          }
        }
        return max * 1.5;
     },

     loadData: function(year) {

       var url = '/api/booking/incoming-money';
       if (year) {
         url += '?year='+year;
       }

  	   $.ajax({
  	   	       type: 'GET',
  	   	       url : url,
  	   	       contentType: 'application/json; charset=utf-8',
  		         dataType : 'json',
  		         success: function(data, textStatus, jqXHR) {
                  bookingIncomingModel.result = data;
                  bookingIncomingModel.graphData.labels = [];
                  bookingIncomingModel.graphData.datasets[0].data = [];
                  for (item in data) {
                    bookingIncomingModel.graphData.labels.push(item);
                    bookingIncomingModel.graphData.datasets[0].data.push(new Number(data[item].total));
                  }

                  bookingIncomingView.update('data_available');
              }
          });

     }

  };

  bookingIncomingController = {

  };

  bookingIncomingView = {

     ctx : null,
     chart: null,

     init : function() {
     	this.ctx = document.getElementById("incoming_money_graphic").getContext("2d");
     },

     update: function(status) {

        switch(status) {
        	case 'data_available':
            if (this.chart) {
             $('#incoming_money_graphic').replaceWith('<canvas id="incoming_money_graphic" width="640" height="500"></canvas>');
        	   this.ctx = document.getElementById("incoming_money_graphic").getContext("2d");
            }
            this.chart = new Chart(this.ctx).Bar(bookingIncomingModel.graphData, {scaleOverride: true, scaleStartValue: 0, scaleStepWidth: bookingIncomingModel.maxValue() / 20 , scaleSteps: 20, scaleIntegersOnly: true });
        	  $("#incoming_money_data").html(tmpl('booking_incoming_table', {data: bookingIncomingModel.result}));
        	  break;
        }

       
     }

  };

  bookingIncomingView.init();
  bookingIncomingModel.loadData(<%=current_year%>);

});