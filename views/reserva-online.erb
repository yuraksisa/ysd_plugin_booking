
  <div id="content-reserva">
  
    <div id="content-header" class="bottom-margin">
        <div>
          <div id="wizard-navigation">
            <ul id="wizard-options">
              <li>
              	 <a id="tab-choose-item" href="#" class="tab img_txt">
              	   <span>1</span>
              	   <%= t.new_booking.choose_item(t.booking_items[booking_item_type.to_sym]) %>
                 </a>
              </li>
              <li>
              	 <a id="tab-choose-extras" href="#" class="tab img_txt">
              	 	<span>2</span>
              	 	<%=t.new_booking.choose_extras%>
              	 </a>
              </li>
              <li>
              	  <a id="tab-complete-reservation" href="#" class="tab img_txt">
              	  	<span>3</span>
              	  	<%=t.new_booking.complete_booking%>
              	  </a>
              </li>
              <li>
              	  <a id="tab-payment" href="#" class="tab img_txt">
              	  	<span>4</span>
              	  	<%=t.new_booking.payment%>
              	  </a>
              </li>
            </ul>
          </div>
        </div>      
    </div>
    
    <div id="content-body" class="element-form-detail bottom-margin">
      <!-- ITEM SELECTION TAB -->
	  <div id="item-selection" class="bottom-margin">
		  <form id="form-search-item" name="form-search-item">
		    <fieldset>
		      <div class="formrow">
		      	<label for="datefrom" id="labeldatefrom" class="fieldtitle search-form-column columna1">
		      		<%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.arrival_date):(t.new_booking.pickup_date)%>
		      	</label> 
		      	<input type="text" name="datefrom" id="datefrom" class="date_control" size="10" maxlength="10"/>
		      	<% if booking_item_family.time_to_from %>
		      	<select name="timefrom" id="timefrom"> 
					<option value="7:00" selected="selected">7:00</option>
					<option value="7:30">7:30</option>
					<option value="8:00">8:00</option>
					<option value="8:30">8:30</option>
					<option value="9:00">9:00</option>
					<option value="9:30">9:30</option>
					<option value="10:00">10:00</option>
					<option value="10:30">10:30</option>
					<option value="11:00">11:00</option>
					<option value="11:30">11:30</option>
					<option value="12:00">12:00</option>
					<option value="12:30">12:30</option>
					<option value="13:00">13:00</option>
					<option value="13:30">13:30</option>
					<option value="14:00">14:00</option>
					<option value="14:30">14:30</option>
					<option value="15:00">15:00</option>
					<option value="15:30">15:30</option>
					<option value="16:00">16:00</option>
					<option value="16:30">16:30</option>
					<option value="17:00">17:00</option>
					<option value="17:30">17:30</option>
					<option value="18:00">18:00</option>
					<option value="18:30">18:30</option>
					<option value="19:00">19:00</option>
					<option value="19:30">19:30</option>
					<option value="20:00">20:00</option>
					<option value="20:30">20:30</option>
					<option value="21:00">21:00</option>
					<option value="21:30">21:30</option>
					<option value="22:00">22:00</option>
					<option value="22:30">22:30</option>
					<option value="23:00">23:00</option>
					<option value="23:30">23:30</option>
		      	</select>
                <% end %>
		      </div>
              <% if booking_item_family.pickup_return_place %>
		      <div class="formrow">
	              <div class="collection_place">
	                 <label for="pickup_place" class="fieldtitle columna1"><%=t.new_booking.place%></label>
	                 <select name="pickup_place" class="fieldcontrol" id="pickup_place">
	                 </select>
	              </div>
	              <div>
	                 <input type="text" name="pickup_place_other" id="pickup_place_other" maxlength="80" size="28" style="display:none;" placeholder="<%=t.new_booking.pickup_place%>"/>
	              </div>
	              <input type="hidden" name="pickup_place_value" id="pickup_place_value"/>
	          </div>          		      	
	          <% end %>	       
		      <div class="formrow">
		      	<label for="dateto" id="labeldateto" class="fieldtitle search-form-column columna1">
		      	  <%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.departure_date):(t.new_booking.return_date)%>
		      	</label> 
		      	<input type="text" name="dateto" id="dateto" class="date_control" size="10" maxlength="10"/>
		      	<% if booking_item_family.time_to_from %>
		      	<select name="timeto" id="timeto"> 
					<option value="7:00" selected="selected">7:00</option>
					<option value="7:30">7:30</option>
					<option value="8:00">8:00</option>
					<option value="8:30">8:30</option>
					<option value="9:00">9:00</option>
					<option value="9:30">9:30</option>
					<option value="10:00">10:00</option>
					<option value="10:30">10:30</option>
					<option value="11:00">11:00</option>
					<option value="11:30">11:30</option>
					<option value="12:00">12:00</option>
					<option value="12:30">12:30</option>
					<option value="13:00">13:00</option>
					<option value="13:30">13:30</option>
					<option value="14:00">14:00</option>
					<option value="14:30">14:30</option>
					<option value="15:00">15:00</option>
					<option value="15:30">15:30</option>
					<option value="16:00">16:00</option>
					<option value="16:30">16:30</option>
					<option value="17:00">17:00</option>
					<option value="17:30">17:30</option>
					<option value="18:00">18:00</option>
					<option value="18:30">18:30</option>
					<option value="19:00">19:00</option>
					<option value="19:30">19:30</option>
					<option value="20:00">20:00</option>
					<option value="20:30">20:30</option>
					<option value="21:00">21:00</option>
					<option value="21:30">21:30</option>
					<option value="22:00">22:00</option>
					<option value="22:30">22:30</option>
					<option value="23:00">23:00</option>
					<option value="23:30">23:30</option>
		      	</select>
		      	<% end %>
		      </div>
	          <% if booking_item_family.pickup_return_place %>
	          <div class="formrow">
	               <div class="return_place">
	                  <label for="return_place" class="fieldtitle columna1"><%=t.new_booking.place%></label>
	      	          <select name="return_place" id="return_place" class="fieldcontrol">
	                  </select>
                   </div>
	               <div>
	                  <input type="text" name="return_place_other" id="return_place_other" maxlength="80" size="28" style="display:none;" placeholder="<%=t.new_booking.return_place%>"/>  
	               </div>
	               <input type="hidden" name="return_place_value" id="return_place_value"/>
	          </div>
	          <% end %>
		      <div class="formrow">
		      	<div class="columna1">
                  &nbsp;
		      	</div>
	        	<input type="submit" value="<%=t.new_booking.search%>" id="button_calcular_tarifas" class="botones"/>
		      </div>  
		    </fieldset>	  
		  </form>
		  <div id="result" class="top-separator">
		  </div>
	  </div>
      <!-- EXTRAS SELECTION TAB -->
      <div id="extras-selection" class="bottom-margin" style="display:none">
      	<form>
          <div class="guiblock">
          	<div class="container_12">
          	  <div >
	            <fieldset id="fs_summary_item">
                  <div class="grid_3">
	                <img id="item_image"/>
	              </div>
	              <div class="grid_4">
	                <div class="right-margin smaller_text">
                      <select id="booking[item_id]" name="booking[item_id]" class="item_chooser"></select>	
	                  <div>
	                    <label class="fieldtitle" style="display:inline-block; width:25%">
	          	         <%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.arrival):(t.new_booking.pickup)%>
	                    </label>
                        <input type="text" name="date_from_extended" id="date_from_extended" class="readonly-field" readonly="readonly" style="width:65%"/>
	                  </div>

                      <% if booking_item_family.pickup_return_place %>
		              <div>
	                     <div class="collection_place">
	                     <label for="pickup_place_extended" class="fieldtitle" style="display:inline-block; width:25%"><%=t.new_booking.place%></label>
	                     <input type="text" name="pickup_place_extended" id="pickup_place_extended" class="readonly-field" readonly="readonly"/>
	                     </div>
	                  </div>
	                  <% end %>	    

	                  <div>
	                    <label class="fieldtitle" style="display:inline-block; width:25%">
	          	          <%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.departure):(t.new_booking.return)%>
	                    </label>
                        <input type="text" name="date_to_extended" id="date_to_extended" class="readonly-field" readonly="readonly"/>
	                  </div>

                      <% if booking_item_family.pickup_return_place %>
		              <div >
	                    <div class="return_place">
	                      <label for="return_place_extended" class="fieldtitle" style="display:inline-block; width:25%"><%=t.new_booking.place%></label>
	      	              <input type="text" name="return_place_extended" id="return_place_extended" class="readonly-field" readonly="readonly"/>
                        </div>
                      </div>
	                  <% end %>	    
                      
                      <% if (booking_item_family.guests) %>
                      <div >
		                <div>
		                  <label id="label_adult_guests" for="booking[number_of_adults]" class="fieldtitle" style="display:inline-block; width:25%"><%=t.new_booking.guests.adults%></label>	
		                  <select name="booking[number_of_adults]" id="booking[number_of_adults]" style="margin-right:5%"> 
			                <option value="1" selected="selected">1</option>
				            <option value="2">2</option>
				            <option value="3">3</option>
				            <option value="4">4</option>
				            <option value="5">5</option>
				            <option value="6">6</option>
				            <option value="7">7</option>
				            <option value="8">8</option>
				            <option value="9">9</option>
				            <option value="10">10</option>
                          </select>
		                  <label id="label_adult_guests" for="booking[number_of_children]" class="fieldtitle" style="display:inline-block"><%=t.new_booking.guests.children%></label>	
		                  <select name="booking[number_of_children]" id="booking[number_of_children]"> 
			                <option value="0" selected="selected">0</option>
				            <option value="1">1</option>
				            <option value="2">2</option>
				            <option value="3">3</option>
				            <option value="4">4</option>
				            <option value="5">5</option>
				            <option value="6">6</option>
				            <option value="7">7</option>
				            <option value="8">8</option>
				            <option value="9">9</option>
				            <option value="10">10</option>
                          </select>
                        </div>    
                      </div>                   
                      <% end %>		                
	                </div>
	              </div>
	              <div class="grid_5">
	                <div class="left-margin smaller_text">
	      	          <input type="hidden" name="total_cost" id="total_cost"/>
	      	          <div id="detailed_summary" style="border: 1px solid #DDD">
	                  </div>      
	                </div>
	              </div>
	            </fieldset>
	          </div>
	        </div>
          </div>

	      <fieldset id="fs_summary_extras">
	        <legend id="lg_summary_extras" class="legend-first-level"><%=t.new_booking.extras%></legend>	        
	        <table id="tblextras">
	          <tbody>
	          </tbody>
	        </table>
	      </fieldset>

	      <div class="content_data_box">
	        <fieldset>
	          <input type="button" value="<%=t.new_booking.continue%>" id="button_continua_rellenar_datos" class="form-button"/>
	        </fieldset>
	      </div>
        </form>
      </div>

	  <form id="form-reservation" name="form-reservation" class="bottom-separator top-space bottom-space bottom-margin" method="POST" style="display:none">
	    <div>	      
	      <fieldset id="fs_customer">
	        <legend id="lg_customer" class="legend-first-level"><%=t.new_booking.customer%></legend>
	        <div class="formrow">
	          <label id="label_customer_email" for="booking[customer_name]" class="fieldtitle"><%=t.new_booking.customer_name.label%> *</label>
	          <input type="text" name="booking[customer_name]" id="booking[customer_name]" class="fieldcontrol" maxlength="40" placeholder="<%=t.new_booking.customer_name.placeholder%>"/>
	        </div>
	        <div class="formrow">
	          <label id="label_customer_surname" for="booking[customer_surname]" class="fieldtitle"><%=t.new_booking.customer_surname.label%> *</label>
	          <input type="text" name="booking[customer_surname]" id="booking[customer_surname]" class="fieldcontrol" maxlength="40" placeholder="<%=t.new_booking.customer_surname.placeholder%>"/>	          
	        </div>
	        <div class="formrow">
	          <label id="label_customer_email" for="booking[customer_email]" class="fieldtitle"><%=t.new_booking.customer_email.label%> *</label>
	          <input type="text" name="booking[customer_email]" id="booking[customer_email]" class="fieldcontrol" placeholder="<%=t.new_booking.customer_email.placeholder%>" maxlength="40"/>
	        </div>
	        <div class="formrow">
	          <label id="label_customer_email_confirmation" for="booking[customer_email_confirmation]" class="fieldtitle"><%=t.new_booking.customer_email_confirmation.label%> *</label>
	          <input type="text" name="booking[customer_email_confirmation]" id="booking[customer_email_confirmation]" class="fieldcontrol" placeholder="<%=t.new_booking.customer_email_confirmation.placeholder%>" maxlength="40"/>
	        </div>
	        <div class="formrow">
	          <label id="label_customer_phone" for="booking[customer_phone]" class="fieldtitle"><%=t.new_booking.customer_phone.label%> *</label>
	          <input type="text" name="booking[customer_phone]" id="booking[customer_phone]" class="fieldcontrol" maxlength="15" placeholder="<%=t.new_booking.customer_phone.placeholder%>"/>      
	        </div>
	        <div class="formrow">
	          <label id="label_customer_mobile_phone" for="booking[customer_mobile_phone]" class="fieldtitle"><%=t.new_booking.customer_mobile.label%></label>
	          <input type="text" name="booking[customer_mobile_phone]" id="booking[customer_mobile_phone]" class="fieldcontrol" maxlength="15" placeholder="<%=t.new_booking.customer_mobile.placeholder%>"/>      
	        </div>
	        <% if booking_item_family.driver %>
	        <div class="formrow bottom-space">
	            <label id="label_driver_date_of_birth" for="booking[driver_date_of_birth]" class="fieldtitle"><%=t.new_driving_booking.driver_date_of_birth.label%> *</label>
                <select name="booking[driver_date_of_birth_day]" id="booking[driver_date_of_birth_day]"></select>
                <select name="booking[driver_date_of_birth_month]" id="booking[driver_date_of_birth_month]"></select>
                <select name="booking[driver_date_of_birth_year]" id="booking[driver_date_of_birth_year]"></select>
                <input type="hidden" name="booking[driver_date_of_birth]" id="booking[driver_date_of_birth]"></input>
	        </div>		        	        
	        <% end %>
	      </fieldset>

	      <fieldset id="fs_info">
	        <legend id="lg_info" class="legend-first-level"><%=t.new_booking.other_data%></legend>
	        <div class="formrow">
	          <label id="label_comments" for="booking[comments]" class="fieldtitle"><%=t.new_booking.comments.label%></label>
	          <textarea id="booking[comments]" name="booking[comments]" class="fieldcontrol" rows="10" placeholder="<%=t.new_booking.comments.placeholder%>"></textarea>
	        </div>	      
	        <p class="form-reservation-right-column"> <span id="booking_comments_length"></span> <%=t.available_chars%></p>
	      </fieldset>
	      
	      <% if booking_item_family.driver %>
	      <fieldset id="fs_driver">
	        <legend id="lg_driver" class="legend-first-level overflow">
	        	<%=t.new_driving_booking.driver.label%>
	        	<span id="show_driver" data-icon="&#xe06d;" aria-hidden=true class="right-float"></span>
	        </legend>	             
	        <p class="fieldset_description"><%=t.new_driving_booking.driver.description%></p>
	        <div id="driver_data" class="background-color-2 top-space bottom-space left-space right-space" style="display:none">
	          <legend class="legend-second-level"><%=t.new_driving_booking.driver_personal_data%></legend>
	          <div class="formrow">
	            <label id="label_driver_name" for="booking[driver_name]" class="fieldtitle"><%=t.new_driving_booking.driver_name.label%></label>
	            <input type="text" name="booking[driver_name]" id="booking[driver_name]" class="fieldcontrol" maxlength="40" placeholder="<%=t.new_driving_booking.driver_name.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_driver_surname" for="booking[driver_surname]" class="fieldtitle"><%=t.new_driving_booking.driver_surname.label%></label>
	            <input type="text" name="booking[driver_surname]" id="booking[driver_surname]" class="fieldcontrol" maxlength="40" placeholder="<%=t.new_driving_booking.driver_surname.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_driver_document" for="booking[driver_document_id]" class="fieldtitle"><%=t.new_driving_booking.driver_nif.label%></label>
	            <input type="text" name="booking[driver_document_id]" id="booking[driver_document_id]" class="fieldcontrol" maxlength="15" placeholder="<%=t.new_driving_booking.driver_nif.placeholder%>"/>
	          </div>	        
              <legend class="legend-second-level top-margin"><%=t.new_driving_booking.driver_license%></legend>
	          <div class="formrow">
	            <label id="label_driver_driving_license_number" for="booking[driver_driving_license_number]" class="fieldtitle"><%=t.new_driving_booking.driver_license_number.label%></label>
	            <input type="text" name="booking[driver_driving_license_number]" id="booking[driver_driving_license_number]" class="fieldcontrol" maxlength="15" placeholder="<%=t.new_driving_booking.driver_license_number.placeholder%>"/>
	          </div>
	          <div class="formrow">
  	            <label id="label_driver_driving_license_date" for="booking[driver_driving_license_date]" class="fieldtitle"><%=t.new_driving_booking.driver_license_date.label%></label>
	            <select name="booking[driver_driving_license_date_day]" id="booking[driver_driving_license_date_day]"></select>
                <select name="booking[driver_driving_license_date_month]" id="booking[driver_driving_license_date_month]"></select>
                <select name="booking[driver_driving_license_date_year]" id="booking[driver_driving_license_date_year]"></select>
                <input type="hidden" name="booking[driver_driving_license_date]" id="booking[driver_driving_license_date]"></select>    
	          </div>
	          <div class="formrow">
	            <label id="label_driver_driving_license_country" for="booking[driver_driving_license_country]" class="fieldtitle"><%=t.new_driving_booking.driver_license_country.label%></label>
	            <input type="text" name="booking[driver_driving_license_country]" id="booking[driver_driving_license_country]" class="fieldcontrol" maxlength="50" placeholder="<%=t.new_driving_booking.driver_license_country.placeholder%>"/>
	          </div>
              <legend class="legend-second-level top-margin"><%=t.new_driving_booking.driver_address%></legend>
	          <div class="formrow">
	            <label id="label_driver_address_street" for="booking[driver_address[street]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_street.label%></label>
	            <input type="text" name="booking[driver_address[street]]" id="booking[driver_address[street]]" class="fieldcontrol" maxlength="60" placeholder="<%=t.new_driving_booking.driver_address_street.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_number" for="booking[driver_address[number]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_number.label%></label>
	            <input type="text" name="booking[driver_address[number]]" id="booking[driver_address[number]]" class="fieldcontrol" maxlength="10" placeholder="<%=t.new_driving_booking.driver_address_number.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_complement" for="booking[driver_address[complement]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_complement.label%></label>
	            <input type="text" name="booking[driver_address[complement]]" id="booking[driver_address[complement]]" class="fieldcontrol" maxlength="20" placeholder="<%=t.new_driving_booking.driver_address_complement.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_city" for="booking[driver_address[city]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_city.label%></label>
	            <input type="text" name="booking[driver_address[city]]" id="booking[driver_address[city]]" class="fieldcontrol" maxlength="60" placeholder="<%=t.new_driving_booking.driver_address_city.placeholder%>"/>      
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_state" for="booking[driver_address[state]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_state.label%></label>
	            <input type="text" name="booking[driver_address[state]]" id="booking[driver_address[state]]" class="fieldcontrol" maxlength="60" placeholder="<%=t.new_driving_booking.driver_address_state.placeholder%>"/>    
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_country" for="booking[driver_address[country]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_country.label%></label>
	            <input type="text" name="booking[driver_address[country]]" id="booking[driver_address[country]]" class="fieldcontrol" maxlength="50" placeholder="<%=t.new_driving_booking.driver_address_country.placeholder%>"/>      
	          </div>
	          <div class="formrow">
	            <label id="label_driver_address_zip" for="booking[driver_address[zip]]" class="fieldtitle"><%=t.new_driving_booking.driver_address_zip.label%></label>
	            <input type="text" name="booking[driver_address[zip]]" id="booking[driver_address[zip]]" class="fieldcontrol" maxlength="10" placeholder="<%=t.new_driving_booking.driver_address_zip.label%>"/>         
	          </div>
	        </div>
	      </fieldset>
	      <% end %>

	      <% if booking_item_family.flight %>
	      <fieldset id="fs_flight">
	        <legend id="lg_flight" class="legend-first-level overflow">
	        	<%=t.new_booking.flight.title%>
	        	<span id="show_flight" data-icon="&#xe06d;" aria-hidden=true class="right-float"></span>
	        </legend>	
	        <div id="flight_data" class="background-color-2 top-space bottom-space left-space right-space" style="display:none">
	          <div class="formrow">
	            <label id="label_flight_company" for="booking[flight_company]" class="fieldtitle"><%=t.new_booking.flight.company.label%></label>
	            <input type="text" name="booking[flight_company]" id="booking[flight_company]" 
	                   class="fieldcontrol" maxlength="80" placeholder="<%=t.new_booking.flight.company.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_flight_company" for="booking[flight_number]" class="fieldtitle"><%=t.new_booking.flight.number.label%></label>
	            <input type="text" name="booking[flight_number]" id="booking[flight_number]" 
	                   class="fieldcontrol" maxlength="10" placeholder="<%=t.new_booking.flight.number.placeholder%>"/>
	          </div>
	          <div class="formrow">
	            <label id="label_flight_company" for="booking[flight_time]" class="fieldtitle"><%=t.new_booking.flight.time.label%></label>
	            <input type="text" name="booking[flight_time]" id="booking[flight_time]" 
	                   class="fieldcontrol" maxlength="5" placeholder="<%=t.new_booking.flight.time.placeholder%>"/>
	          </div>	          
	        </div>
	      </fieldset>
	      <% end %>	      
	    
	    </div>

	    <div id="reservation-summary" class="content_data_box">
	      <fieldset id="fs_conditions">
	        <div>
	          <input type="checkbox" name="conditions_read" id="conditions_read">
	            <span class="conditions_text">
	           	  <%=t.new_booking.conditions_confirm('/renting_conditions')%>
	            </span>
	          </input>
	        </div>        
	      </fieldset>	      
	      <fieldset id="fs_confirm">
	      	  <input type="button" value="<%=t.new_booking.continue%>" id="button_ir_a_pagar_reserva" class="form-button botones" style="display:none"/>
	          <input type="submit" value="<%=t.new_booking.confirm%>" id="button_confirmar_reserva" class="form-button botones" style="display:none"/>
	      </fieldset>
	      <div id="reservation_error">
	      </div>	
	    </div>
	     
        <input type="hidden" name="booking[source]" id="booking[source]"/>

	  </form>
	  
      <div id="booking-payment" style="display:none">

        <div id="booking_summary">
        </div>
        
        <h3 class="guiblock-title"><%=t.booking.payment.label%></h3>
        <form name="form-payment" id="form-payment">
          <% if booking_deposit > 0 %>
            <div class="radio-block">
              <input type="radio" name="booking[payment]" value="total" checked="true"><%=t.booking.payment_type.total.label%></input>
              <p id="payment_total" class="radio-info less_contrast_text"></p>
            </div>
            <div class="radio-block">
              <input type="radio" name="booking[payment]" value="deposit"><%=t.booking.payment_type.deposit.label%></input>
              <p id="payment_deposit" class="radio-info less_contrast_text"></p>
            </div>
          <% else %>
            <input type="hidden" name="booking[payment]" value="total"/>          
          <% end %> 	
          <div id="payment_methods">
             <h4 class="top-margin bottom-margin"><%=t.new_booking.payment_methods%></h4>
             <div id="payment_methods_selector"></div>
          </div>
          <div class="formrow-botonera">
             <input type="submit" class="form-button botones" value="<%=t.new_booking.booking%>"/>
          </div>
	      <div id="payment_error">
	      </div>	          
        </form>

      </div>

	  <div id="booking-complete-message">
	  
	  </div>
	  
      <!-- overlayed element -->
      <div class="apple_overlay" id="overlay">

	     <!-- the external content is loaded inside this tag -->
	     <div class="contentWrap"></div>

      </div>	  
	  
      <div id="sending-booking" title="<%=t.new_booking.sending_booking_request%>" style="display:none">
        <img src="/img/ajax-loader_grande.gif"/>
      </div>
            
    </div>
      
    <div id="content-footer">
      
    </div>  
      
  </div>
  
  <!-- JS TEMPLATES -->
  
  <script type="text/tmpl" id="script_extras">
  	          <tr class="booking_extra" id="booking_extra_<%%=extra.id%>" <%% if (!extra.optionalAccepted(optional)) {%> style="display:none" <%% } %> >
	            <td>
	               <input type="checkbox" name="extras[<%%=extra.id%>[extra_id]]" id="extras[<%%=extra.id%>[extra_id]]" value="<%%=extra.id%>" rel="extras[<%%=extra.id%>[quantity]]" class="extra"/>
	            </td>
	            <td>   
	               <label id="label_extra_<%%=extra.id%>"><%%=extra.the_name%></label>
	            </td>
	            <td>
	               <%% if (extra.max_quantity > 1) { %>
	               <select name="extras[<%%=extra.id%>[quantity]]" id="extras[<%%=extra.id%>[quantity]]" class="extraquantity" rel="<%%=extra.id%>">
	                 <option value="0" selected="selected">0</option>
	                 <%% for (var idx=1; idx <= extra.max_quantity; idx++) { %>
	                   <option value="<%%=idx%>"><%%=idx%></option>
	                 <%% } %>
	               </select>	
	               <%% } %>            
	            </td>
	          </tr>
  </script>
  
  <script type="text/tpml" id="script_detailed_price">
      <table class="detailed_price">
        <thead>
          <tr>
            <th><%=t.new_booking.concept%></th>
            <th><%=t.new_booking.quantity%></th>
            <th><%=t.new_booking.days%></th>
            <th><%=t.new_booking.price%></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="first_column"><%%= bookingDataSystem.families[booking.item_id].cars %> <%% if (booking.optional) { %> <%%='('+bookingDataSystem.optionals[booking.optional].name+')'%> <%% } %> </td>
            <td class="quantity_column"><%%= booking.quantity %> </td>
            <td class="quantity_column"><%%= booking.days %> </td>
            <td class="quantity_column"><%%= booking.item_cost %>€ </td>
          </tr>
          <%% for (extra in booking.booking_extras) { %>
            <tr>
              <td class="first_column"><%%= bookingDataSystem.extras[booking.booking_extras[extra].extra_id].the_name %></td>
              <td class="quantity_column"><%%= booking.booking_extras[extra].quantity %></td>
              <td class="quantity_column"><%%= booking.days %> </td>
              <td class="quantity_column"><%%= booking.booking_extras[extra].extra_cost %>€</td>
            </tr>
          <%% } %>
          <tr>
            <td class="total_column first_column"><%=t.new_booking.total.upcase%></td>
            <td class="quantity_column"></td>
            <td class="quantity_column"></td>
            <td class="quantity_column total_column"><%%= booking.total_cost %>€ </td>
          </tr>
        </tbody>      
      </table>
  
  </script>
  
  <script type="text/tpml" id="script_booking_summary">
      
      <h3 class="guiblock-title"><%=t.new_booking.title%></h3>

      <p><span class="highlighted_text"><%%= item %></span></p>
      <p><span class="highlighted_text"><%=(booking_item_family.start_date_literal==:arrival)?(t.booking.arrival):(t.new_booking.pickup)%>:</span> <%%= date_from %></p>
      <p><span class="highlighted_text"><%=(booking_item_family.start_date_literal==:arrival)?(t.booking.departure):(t.new_booking.return)%>:</span> <%%= date_to %></p>
 
      <h3 class="guiblock-title"><%=t.new_booking.price%></h3>

      <%%= priceSummary %>

      <p class="content_data_box" style="text-align: center; margin-left:auto; margin-right: auto; display: table">
         <%=t.new_booking.confirm_message%>
      </p>

  </script>

  <script type="text/tpml" id="script_booking_finished">
	  <% if defined?(booking_summary_message) %>
	   <%= booking_summary_message %>
	  <% end %>
  </script>
  
  <!-- CODE -->
  
  <script type="text/javascript">
  
  <% if defined?booking_js %>
    <%= booking_js %>
  <% end %>

  require(['jquery', 'YSDForms', 'YSDDateControl', 'ysdtemplate',
  	       <% if defined?booking_js %>'booking_js'<% else %>'/js/booking.js'<%end%>, 
           'YSDListSelector', 'YSDRemoteDataSource', 'json2', 'jquery.validate', 
  	       'jquery.placeholder', 'jquery.ui', 'jquery.ui.datepicker-es', 
  	       'jquery.ui.datepicker.validation',
  	       'jquery.tools', 'jquery.formparams', 'datejs'], 
  	       function($, YSDForms, DateControl, tmpl, bookingDataSystem,  
  	       ListSelector, RemoteDataSource) {  

    /* It represents the wizard tabs */

    var WizardTab = function (element_id, visible) {
       	
      this.element_id = element_id;
      this.state = null;
                	         	  
      this.setState = function(new_state) { /* set the state (not-enabled, active, not-active) */ 
       	  
        this.state = new_state;
      	    
        switch (this.state) {
       	    
  	      case 'not-enabled':
   	        $('#' + this.element_id).removeClass('active not-active').addClass('not-enabled');
   	        break;
       	        
   	      case 'active':
   	        $('#' + this.element_id).removeClass('not-active not-enabled').addClass('active');
   	        break;
       	        
   	      case 'not-active':
   	        $('#' + this.element_id).removeClass('active not-enabled').addClass('not-active');
   	        break;
       	       
        }         	    
      
      };
       	  
      this.setVisible = function(visible) { /* setVisible */
        this.visible = visible;	
       	    
       	if (this.visible) {
       	  $('#' + element_id).show();
       	}
       	else {
       	  $('#' + element_id).hide();
       	}
       	    
       	return this;
      }
       	
      this.setVisible(visible);

    };
 

    /* ----------------------------------- */
    /* An object that represents the MODEL */
    /* ----------------------------------- */
        
    var bookingModel = {

       all_prices : [],    /* Caches all models prices for the period */
       exceeded_hours : bookingDataSystem.gracePeriod || 2, /* Used when calculating prices. When exceeded it's considered one more day */
       pickup_places : bookingDataSystem.pickup_places,
       allow_custom_pickup_place : bookingDataSystem.allow_custom_pickup_place,
       return_places : bookingDataSystem.return_places,
       allow_custom_return_place : bookingDataSystem.allow_custom_pickup_place,
       process_states : [ 'item_selection', 
         'extras_selection',
         'completing_booking', 
         'pay_booking', 
         'continue_booking', 
         'sending_booking', 
         'process_finished', 
         'process_error' ],
       process_state : 'item_selection',
       confirmBookingResponse : null, /* It holds the confirm booking response */       
       booking : {

          date_from : null, /* the booking date from */
          time_from : null, /* the booking time from */
          date_to : null, /* the booking date to */
          time_to: null, /* the booking time to */
          pickup_place: null, /* the pick up place */
          return_place: null, /* the return place */
          date_to_price_calculation : null, /* the date to used when calculating prices */
          days: 0, /* renting days */
          quantity: 1, /* Number of products */
          item_id : null, /* the booking item */
          item_description: null, /* the booking item description */

          optional: null, /* the booking optional */
       
          item_cost : 0, /* the item cost */
          extras_cost : 0, /* the extras cost */
          total_cost : 0, /* the total cost (item + extras) */
          booking_extras : {}, /* The booking extras */
          booking_amount: 0, /* The amount to pay to confirm the booking */

          set_item : function (item_id) { /* Set the booking item */
          	
          	old_cost = this.item_cost;
            this.item_id = item_id;
            this.item_description = bookingDataSystem.families[item_id].description;
            if (this.optional != null) {
              this.item_cost = bookingModel.all_prices[item_id][this.optional];
            }
            else {
       	      this.item_cost = bookingModel.all_prices[item_id];
       	    }
       	    this.addCost( this.item_cost - old_cost);

       	    for (extra in this.booking_extras) { /* Calc the extra prices - can change with the item family - */
       	      this.booking_extras[extra].reCalcCost();	
       	    }
          	
          },
          
          /* Set the optional */
          set_optional : function(optional) {
          	var extras = bookingDataSystem.extras;
         	this.optional = optional;
            if (optional != null) {
              for (extraId in this.booking_extras){ 
                if (!extras[extraId].optionalAccepted(optional)) {
                  this.remove_extra(extraId);
                }
              }
              bookingView.update_information('optional');
            }
          },

          addExtraCost : function (value) { /* Add extra cost */
            this.extras_cost += value;
            this.addCost( value );
          },
  
          addCost : function (value) { /* Add cost */
   	         this.total_cost += value;
   	         this.booking_amount = new Number(this.total_cost * 
             	<%=booking_deposit%> / 100).toFixed(0);
          },          
                               
          BookingExtra : function (extra_id, quantity) {
   	 
   	         this.extra_id = extra_id;
   	         this.quantity = quantity;
   	         this.extra_description = bookingDataSystem.extras[extra_id].the_name;
   	         this.extra_unit_cost = bookingDataSystem.calculate_extra_price(bookingModel.booking.date_from, 
   	         	bookingModel.booking.date_to_price_calculation, this.extra_id, bookingModel.booking.item_id);
   	         this.extra_cost = this.quantity * this.extra_unit_cost;
   	         this.data = bookingDataSystem.extras[extra_id];
 
             this.set_quantity = function (new_quantity) {
     	
     	        this.quantity = new_quantity;
     	        var old_extra_cost = this.extra_cost;
     	        this.extra_cost = new_quantity * this.extra_unit_cost;         
                bookingModel.booking.addExtraCost (this.extra_cost - old_extra_cost);  

             }
 
             this.reCalcCost = function() { /* Computes the extra price */

                var old_extra_cost = this.extra_cost;
                this.extra_unit_cost = bookingDataSystem.calculate_extra_price(bookingModel.booking.date_from, 
                	bookingModel.booking.date_to_price_calculation, this.extra_id, bookingModel.booking.item_id);
                this.extra_cost = this.quantity * this.extra_unit_cost;
                if (this.extra_cost != old_extra_cost) {
                  bookingModel.booking.addExtraCost(this.extra_cost - old_extra_cost);
                }
             }

          },
            
                                                       
          add_extra : function (extra_id, quantity) { /* Adds an extra to the booking */
          	          	
          	  this.booking_extras [extra_id] = new this.BookingExtra(extra_id, quantity);
          	  this.addExtraCost (this.booking_extras[extra_id].extra_cost);      	
          	  bookingView.update_information('booking_extras');
          	            	
          },
     
          remove_extra : function (extra_id) { /* Remove an extra from the booking */
          	
        	  var oldCost = this.booking_extras[extra_id].extra_cost;
   	          delete this.booking_extras [extra_id]; 
   	          this.addExtraCost (-oldCost);  
          	  bookingView.update_information('booking_extras');
          	
          },
          
          change_extra_quantity : function (extra_id, new_quantity) { /* Updates an extra quantity */
          	          	
          	  if ( this.booking_extras[extra_id] == null && new_quantity > 0)
          	  {
          	  	 this.add_extra(extra_id, new_quantity);
          	  }
          	  else 
          	  	if (this.booking_extras[extra_id] != null) {          	
          	  	  if (new_quantity == 0) {
          	       this.remove_extra(extra_id);
          	  	  }
          	  	  else {
          	  	 	this.booking_extras[extra_id].set_quantity(new_quantity);
           	        bookingView.update_information('booking_extras');
          	  	  }
          	  }
          	            	
          }
       
       },
      
       
       /* ----------- The methods ----------------- */
       
       getUrlVars : function()
       {
          var vars = [], hash;
          var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
          for(var i = 0; i < hashes.length; i++)
          {
             hash = hashes[i].split('=');
             vars.push(hash[0]);
             vars[hash[0]] = hash[1];
          }
          return vars;
       },

       change_state : function( action ) {
       	
       	  switch (action) {
       	  	 
       	  	 case 'start' :
       	  	   this.process_state = 'item_selection';
       	  	   break;
       	  	       	 
             case 'select_item' :
                this.process_state = "extras_selection";
                break;

       	     case 'select_extras' :
               this.process_state = 'completing_booking';       	     
       	       break;
       	   	       	   	
       	   	 case 'go_to_complete_booking':
       	   	   this.process_state = 'continue_booking';
       	   	   break;
       	   	 
             case 'go_to_pay_booking':
               this.process_state = 'pay_booking';
               break;

       	   	 case 'send_booking':
       	   	   this.process_state = 'sending_booking';
       	   	   break;
       	   	   
       	   	 case 'booking_response_ok':
       	   	   this.process_state = 'process_completed';
       	   	   break;
       	   	   
       	   	 case 'booking_response_error':
       	   	   this.process_state = 'process_error';
       	   	   break;
       	  }
       	       	
       	  bookingView.state_changed(this.process_state);
       	
       },
       
       /* Choose item */
       
       choose_item : function(item, optional) { 
         	
         this.booking.set_optional(optional);
         this.booking.set_item(item); // Sets the item
       	 
       	 this.change_state('select_item');
       	
       },
       
       /* Change the item */
       
       change_item : function(item, optional) {

       	 this.booking.set_optional(optional);
       	 this.booking.set_item(item); // Sets the item
       
         bookingView.update_information('booking_item');
       	
       },

       /* The business logic of calculating prices */
       
       calculate_price : function(date_from, time_from, date_to, time_to, pickup_place, return_place) {
       	
       	 this.booking.date_from = date_from;
       	 this.booking.time_from = time_from;
       	 
       	 this.booking.date_to = date_to;
       	 this.booking.time_to = time_to;

       	 this.booking.pickup_place = pickup_place;
       	 this.booking.return_place = return_place;
       	        	 
       	 var _date_from = new Date( date_from.toString("MM/dd/yyyy ") + time_from);
       	 var _date_to = new Date( date_to.toString("MM/dd/yyyy ") + time_to);
       	        	 
       	 var dias_diferencia = (date_to - date_from) / (1000*60*60*24);
       	 var horas_diferencia = (_date_to - _date_from) / (1000*60*60);
       	 
       	 this.booking.days = Math.max(Math.floor(dias_diferencia),0);
       	 this.booking.date_to_price_calculation = new Date(this.booking.date_to.getTime());
       	 
       	 if (this.exceeded_hours > 0 && (horas_diferencia/24 > dias_diferencia + this.exceeded_hours/24) ) {
       	   this.booking.date_to_price_calculation.add( {days:1});
       	   this.booking.days++;
       	 }

       	 this.all_prices = bookingDataSystem.calculate_items_price(this.booking.date_from, 
       	                                                           this.booking.date_to_price_calculation);
       	       	       	
       },    	
              
       add_extra : function (extra, quantity) { /* Add an extra */
       	
       	this.booking.add_extra (extra, quantity);
       	
       },
       
       remove_extra: function (extra) { /* Remove an extra */
       	
       	this.booking.remove_extra (extra);
       	
       },
       
       change_extra_quantity : function (extra, quantity) { /* Change extra quantity */
       	
       	this.booking.change_extra_quantity (extra, quantity);
       	
       },
                    
       prepare_request_object : function (data) { /* Prepares the request object */
       	
            // Creates a request object with all the information (mixin the model and the data passed)
       
           var request = {
              booking : data.booking
           };
                    
           // Drop the properties not necessary to the request (they only live in the Gui)         
                    
           delete request.booking ['customer_email_confirmation'];   
           delete request.booking ['driver_date_of_birth_day'];
           delete request.booking ['driver_date_of_birth_month'];
           delete request.booking ['driver_date_of_birth_year'];
           delete request.booking ['driver_driving_license_date_day'];
           delete request.booking ['driver_driving_license_date_month'];
           delete request.booking ['driver_driving_license_date_year'];
     
                         
           // Copies the booking model data to the request (only the data)
                     
           for (data in this.booking) {
           
               if (typeof this.booking[data] != 'function')
               {
                 request.booking[data] = this.booking[data];
               }
               
           }
           
           // Copies the booking extras model data to the request
           
           request.booking.booking_extras = [];
            
           var extra_index = 0;
           for (var index in this.booking.booking_extras) {
             request.booking.booking_extras[extra_index++] = { 
             	 extra_id : index,
             	 extra_description: this.booking.booking_extras[index].extra_description,
             	 extra_cost : this.booking.booking_extras[index].extra_cost,
             	 extra_unit_cost : this.booking.booking_extras[index].extra_unit_cost,
             	 quantity : this.booking.booking_extras[index].quantity
             }
           }

           return request;
      	
       	
       },

       stringifyRequest : function(request) {

           return JSON.stringify(
                  request, function (key, value) {
                  	  // Convert the date objects (edited as input text) in the right format
                  	  if (this[key] instanceof Date) {
                  	  	return this[key].toString();
                  	  }
                  	  else   
       	           	  if ((key == 'driver_driving_license_date' || key == 'driver_date_of_birth')) {
       	           	  	
       	           	  	if (typeof value == 'string' && $.trim(value) != '')
       	           	  	{
       	           	  	  return new Date(value).toString();  //return Date.parse(value,'d/M/yyyy').toUTCString();	
       	           	  	}
       	           	    else
       	           	    {
       	           	      return null;  
       	           	    }
       	           	  }
       	             	  return value;
       	             });

       },
       
      go_to_fill_data : function() { /* Go to fill data tab */
      
        this.change_state('go_to_complete_booking');

      },

       go_to_payment : function() { /* Go to the payment tab */

        if ($('#form-reservation').valid()) {
          this.change_state('go_to_pay_booking');
        }

       },

       confirm_booking : function (data) { /* Confirms the booking */
       	 this.confirmBookingResponse = null;
         var json_request = this.stringifyRequest(this.prepare_request_object(data));
         this.change_state('send_booking');      	     
       	 $.ajax( 
       	         {
       	           type : 'POST',
       	           url : bookingDataSystem.configuration.booking_url || '/booking',
       	           data : json_request,
                   dataType: 'html',  /* Response expected from the server */
                   /*crossDomain: true,*/
                   contentType: 'application/json; charset=utf-8', /* Data type sent to the server */
       	                  	           
       	           success : function(data, textStatus, jqXHR) { /* RESPONSE OK */
       	           	 if (jqXHR.getResponseHeader('Content-Type').match(/application\/json/)) {
       	           	   bookingModel.confirmBookingResponse = JSON.parse(data);	
       	           	 }
       	           	 else {
       	           	   bookingModel.confirmBookingResponse = data;	
       	           	 }
       	             bookingModel.change_state('booking_response_ok'); /* textStatus y data */
       	           },	
       	           
       	           error: function(jqXHR, textStatus, errorThrow){ /* RESPONSE ERROR */
       	           	 bookingModel.change_state('booking_response_error'); /* textStatus y errorThrow */
       	           }
       	           
       	         });       
       	
       }
    	
       
    };
    
    /* ---------------------------------------- */
    /* An object that represents the CONTROLLER */
    /* ---------------------------------------- */
    
    var bookingController = {
    
      change_from_date : function(date_from) {
        	
      },
    	
      /* calculate the prices */
      	
      calculate_prices : function (date_from, time_from, date_to, time_to, pickup_place, return_place) {
      	bookingModel.calculate_price(date_from, time_from, date_to, time_to, pickup_place, return_place);
      	bookingView.show_prices();
      },	
    
      /* start booking */
      
      start_booking : function (item, optional) {
      	
      	bookingModel.choose_item(item, optional);
         
      },
      
      change_item : function (item, optional) {
      	
      	bookingModel.change_item(item, optional);
      	
      },
      
      check_extra : function(extra, quantity) { /* check an extra */
      	bookingModel.add_extra(extra, quantity==='0'?1:new Number(quantity));
      },
      
      uncheck_extra : function(extra) {  /* uncheck an extra */
      	bookingModel.remove_extra(extra);
      },

      change_extra_quantity: function(extra, quantity) { /* change the extra quantity */
         bookingModel.change_extra_quantity(extra, new Number(quantity));	
      },
      
      change_pickup_place_select : function(pickup_place) { /* change pickup place */
        
        if ($('#pickup_place :selected').val() == '<%=t.new_booking.other%>' ) {
          $('#pickup_place_other').show();	
          $('#pickup_place_value').val('');
          $('#pickup_place_other').focus();
        } 
        else
        {
          $('#pickup_place_other').hide();
          $('#pickup_place_other').val('');	
          $('#pickup_place_value').val(pickup_place);
        }
        
      },
      
      blur_pickup_place_input : function(pickup_place) {
      
        if ($('#pickup_place_other').val() != $('#pickup_place_value').val()) {
          $('#pickup_place_value').val(pickup_place);
        }
               	
      },
     
      change_return_place_select : function(return_place) { /* change return place */
      	
      	if ($('#return_place :selected').val() == '<%=t.new_booking.other%>'  ) {
          $('#return_place_other').show();
          $('#return_place_value').val(''); 	
          $('#return_place_other').focus();
        } 
        else
        {
          $('#return_place_other').hide();
          $('#return_place_other').val('');	
          $('#return_place_value').val(return_place);
        }      
      
      },
      
      blur_return_place_input : function(return_place) {
      	
        if ($('#return_place_other').val() != $('return_place_value').val()) {
          $('return_place_value').val(return_place);
        }
      	
      },

      go_to_fill_data_click : function() { /* Go to fill data button click */
      
        bookingModel.go_to_fill_data();

      },
      
      go_to_booking_payment_click: function() { /* Go to payment button click */

        bookingModel.go_to_payment();

      },

      confirm_booking : function (data) { /* Confirm button click */
        bookingModel.confirm_booking(data);
      },
        
      /* Copy customer name to driver name */

      copy_customer_to_driver : function() {
      	
        if ($('#booking\\[driver_name\\]').val() == '')
        {
          $('#booking\\[driver_name\\]').val($('#booking\\[customer_name\\]').val());	
        }
      
        if ($('#booking\\[driver_surname\\]').val() == '')
        {
          $('#booking\\[driver_surname\\]').val($('#booking\\[customer_surname\\]').val());	
        }
            	
      }
      
    };
    
    /* ---------------------------------- */
    /* An object that represents the VIEW */
    /* ---------------------------------- */
         
    var bookingView = {
    	    	
       configureBookingGui : function() { /* Configure the Gui elements using the booking configuration */
           	       	 
         var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];

         $('#datefrom').datepicker({numberOfMonths:2, minDate:bookingDataSystem.configuration.min_date, 
         	maxDate: new Date(bookingDataSystem.configuration.max_date).add(-1).days(), dateFormat: 'dd/mm/yy'}, locale);
         $('#datefrom').datepicker('setDate', '+0'); 

         $('#dateto').datepicker({numberOfMonths:2, minDate:new Date(bookingDataSystem.configuration.min_date).add(<%=booking_min_days%>).days(),
            maxDate: bookingDataSystem.configuration.max_date , dateFormat: 'dd/mm/yy'}, locale);
         $('#dateto').datepicker('setDate', '+<%=booking_min_days%>');

         $('#button_continua_rellenar_datos').bind('click', function(event) {
            bookingController.go_to_fill_data_click();
         });

         <% if booking_payment %>
           this.configurePaymentMethods();
           $('#button_ir_a_pagar_reserva').show();
           $('#button_confirmar_reserva').hide();
           $('#button_ir_a_pagar_reserva').bind('click', function(event) {
             bookingController.go_to_booking_payment_click();
           });
         <% else %>  
           $('#button_ir_a_pagar_reserva').hide();
           $('#button_confirmar_reserva').show();
         <% end %>
       	 
       },	    	
       
       init : function () { /* Inits the View */	
       	       	       	       	       	       	
       	 // Configure the date controls
       	 // http://jquery-ui.googlecode.com/svn/trunk/ui/i18n/ (locales for datepicker)
       	 // http://keith-wood.name/uiDatepickerValidation.html (validation for datepicker)
       	 $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );
       	        	   	 
       	 this.configureBookingGui();
  	          
         // Configure driver date of birth and driver license date 
         if (document.getElementById('booking[driver_date_of_birth_day]')) {                                           
           var dataControlDateOfBirth = new DateControl(document.getElementById('booking[driver_date_of_birth_day]'), 
                                              document.getElementById('booking[driver_date_of_birth_month]'),
                                              document.getElementById('booking[driver_date_of_birth_year]'), 
                                              document.getElementById('booking[driver_date_of_birth]'));
         }
         if (document.getElementById('booking[driver_driving_license_date_day]')) {
           var dataControlLicenseDate = new DateControl(document.getElementById('booking[driver_driving_license_date_day]'), 
                                              document.getElementById('booking[driver_driving_license_date_month]'),
                                              document.getElementById('booking[driver_driving_license_date_year]'), 
                                              document.getElementById('booking[driver_driving_license_date]'));
         }
         
         $('#datefrom').bind('change', function() {
           var dateFrom = $('#datefrom').datepicker('getDate');	
           var dateTo = $('#dateto').datepicker('getDate');
           dateTo.setDate(dateFrom.getDate() + <%=booking_min_days%>);
           $('#dateto').datepicker('setDate', dateTo );
           $('#dateto').datepicker('option', 'minDate', dateFrom.add(<%=booking_min_days%>).days());
         });

         $('#show_driver').bind('click',
           function(){
             $('#driver_data').toggle('slow', function() {
               if ($('#driver_data:visible').length>0) {
                 $('#show_driver').attr('data-icon', "\uE06E");	
               }
               else {
                 $('#show_driver').attr('data-icon', "\uE06D");
               }
             });
         });


         $('#show_flight').bind('click',
           function(){
             $('#flight_data').toggle('slow', function() {
               if ($('#flight_data:visible').length>0) {
                 $('#show_flight').attr('data-icon', "\uE06E");	
               }
               else {
                 $('#show_flight').attr('data-icon', "\uE06D");
               }
             });
         });         

         // Configure the comments textarea
         YSDForms.limit_text_area_content_size(document.getElementById('booking[comments]'), 256, 
            function (content_remain) {
              document.getElementById('booking_comments_length').innerHTML = '<strong>' + content_remain + '</strong>';
            }
         );                
         
         // configure place holders
         $('input[placeholder]:visible,textarea[placeholder]:visible').placeholder();
         
         // Configure item behaviour
         $('#booking\\[item_id\\]').bind('change',
           function() {
           	
           	 bookingController.change_item($(this).val(), $(this).find(":selected").attr('data-optional'));
           	
           });
          	 
       	 // Configure the pickup_place and return_place behaviour
       	 $('#pickup_place').bind('change',
       	   function() {
       	   	 bookingController.change_pickup_place_select($(this).text());
       	   });
       	 $('#pickup_place_other').bind('blur',
       	   function() {
       	   	 bookingController.blur_pickup_place_input($(this).val());
       	   });
       	 $('#pickup_place_value').val($('#pickup_place option:selected').text());  
       	   
       	 $('#return_place').bind('change',
       	   function() {
       	   	 bookingController.change_return_place_select($(this).val());
       	   });
       	 $('#return_place_other').bind('blur',
       	   function() {
       	   	 bookingController.blur_return_place_input($(this).val());
       	   });
       	 $('#return_place_value').val($('#return_place option:selected').text());  
       	      	       	
       	 // Configure the dialog(s)
       	 $('#sending-booking').dialog({autoOpen: false, height: 260, modal: true,
       	      closeOnEscape: false,
       	       open: function(event, ui) { $(".ui-dialog-titlebar-close").hide(); },
       	       close: function(event, ui) { $(".ui-dialog-titlebar-close").show(); }
             });
       	 	         
         // Configure name and surname events
         $('#booking\\[customer_name\\],#booking\\[customer_surname\\]').bind('blur',
             function(){
               bookingController.copy_customer_to_driver();
             }
           );
         
       	 // Configure validations	
       	 this.configure_validations();
       	
       	 // Configure state
       	 this.state_changed(bookingModel.process_state);
    
         //
         this.init_form();   	
       	
       },	
       
       init_form : function () {
       	
       	  var url_vars = bookingModel.getUrlVars();
       	  
       	  var datefrom = decodeURIComponent(url_vars['datefrom']);    	  
       	  var timefrom = decodeURIComponent(url_vars['timefrom']);
       	  var dateto = decodeURIComponent(url_vars['dateto']);
       	  var timeto = decodeURIComponent(url_vars['timeto']);
       	  var number_of_adults = decodeURIComponent(url_vars['number_of_adults']);
       	  var number_of_children = decodeURIComponent(url_vars['number_of_children']);
       	  var source = decodeURIComponent(url_vars['source']);
       	  
          if (source != 'undefined') {
          	$('#booking\\[source\\]').val(source);
          }

       	  if (datefrom != 'undefined' && dateto != 'undefined' && 
       	  	  $.datepicker.parseDate("dd/mm/yy", dateto) > $.datepicker.parseDate("dd/mm/yy", datefrom)) {       	  
            $('#datefrom').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", datefrom)); 
            $('#timefrom').val(timefrom);
            $('#dateto').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", dateto)); 
            $('#timeto').val(timeto);    
            this.configureDates();   	   
            this.calculate_prices();

       	  }
       },        
           
       configureDates : function() {

           var dateFrom = $('#datefrom').datepicker('getDate');	
           var dateTo = $('#dateto').datepicker('getDate');
           var nDays = (dateTo - dateFrom) / (3600000*24);

           var dateToMin = $('#datefrom').datepicker('getDate');
           dateToMin.add(Math.max(<%=booking_min_days%>, nDays)).days();
           
           if (dateTo < dateToMin) {
           	dateTo = dateToMin;
           }

           $('#dateto').datepicker('setDate', dateTo );
           $('#dateto').datepicker('option', 'minDate', dateFrom.add(<%=booking_min_days%>).days());

       },

       calculate_prices : function() {

       	    bookingController.calculate_prices($('#datefrom').datepicker("getDate"), 
                                               $('#timefrom option:selected').val(),
                                               $('#dateto').datepicker("getDate"), 
                                               $('#timeto option:selected').val(),
                                               $('#pickup_place_value').val(),
                                               $('#return_place_value').val()); 
       	
       },     
              
       configure_validations : function () {
       	
       	
       	 // Search item form validation
       	 
       	 $('#form-search-item').validate(
       	  {
       	  	
            submitHandler: function(form) {
               bookingView.calculate_prices();
               return false;
            },
                 	        	   
       	    rules : {
       	   
       	       'datefrom': {
       	         required: true	
       	       },
       	     
       	       'dateto': {
       	         required: true,
       	         dpCompareDate : { 'notLessThan' : '#datefrom'} // dateto can not be less than datefrom
       	       }
       	   	
       	    },
       	    
       	    messages : {
       	    	
       	       'datefrom': {
       	       	 required : '<%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.arrival_date_mandatory):(t.new_booking.pickup_date_mandatory)%>'
       	       },	
       	    	
       	       'dateto' : {
       	       	 required : '<%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.departure_date_mandatory):(t.new_booking.return_date_mandatory)%>',
       	       	 dpCompareDate : '<%=(booking_item_family.start_date_literal==:arrival)?(t.new_booking.departure_date_greater_arrival_date):(t.new_booking.return_date_greater_pickup_date)%>'
       	       }	
       	    },
       	    
       	    errorPlacement : function(error, element) {
       	    	
       	    	if (element.attr('name') === 'datefrom') {
       	    	  error.insertAfter('#timefrom');
       	    	}
       	    	
       	    	if (element.attr('name') === 'dateto') {
       	    	  error.insertAfter('#timeto');	
       	    	}
       	    	
       	    }
       	    
       	    
       	  }
       	 );
       	
        $.validator.addMethod('number_of_adults',
          function(value, element) {

           if (bookingDataSystem.families[$('#booking\\[item_id\\]').val()] &&
          	   bookingDataSystem.families[$('#booking\\[item_id\\]').val()].maxNumberOfAdults) {
             return bookingDataSystem.families[$('#booking\\[item_id\\]').val()].maxNumberOfAdults >= 
               parseInt($('#booking\\[number_of_adults\\]').val());
           }

           return true;

          });

        $.validator.addMethod('number_of_children',
          function(value, element) {

           if (bookingDataSystem.families[$('#booking\\[item_id\\]').val()] &&
          	   bookingDataSystem.families[$('#booking\\[item_id\\]').val()].maxNumberOfChildren) {
             return bookingDataSystem.families[$('#booking\\[item_id\\]').val()].maxNumberOfChildren >= 
               parseInt($('#booking\\[number_of_children\\]').val());
           }

           return true;

          });

       	// Booking Form Validation
        $('#form-reservation').validate(
         {
          
           submitHandler: function(form) {
           	 $('#reservation_error').html('');
           	 bookingController.confirm_booking($(form).formParams(false)); // Numbers and booleans are not converted (hold as strings)
           	 return false;
           },
           
           invalidHandler : function (form, validator) {
             $('#reservation_error').html('<%=t.new_booking.form_errors.description%>');
           },
           
           rules : {
           	
           	'booking[number_of_adults]' : 'number_of_adults',
            'booking[number_of_children]' : 'number_of_children',
           	'booking[customer_name]': 'required',
           	'booking[customer_surname]' : 'required',
           	'booking[customer_email]' : {
           	  required: true,
           	  email: true	
           	},
           	'booking[customer_email_confirmation]': {
           	  required: true,
           	  email: true,
           	  equalTo : '#booking\\[customer_email\\]'	/* scape slash with brackets \\[email\\] */
           	},
           	'booking[customer_phone]': {
           	  required: true,
           	  minlength: 9	
           	},
           	'booking[driver_date_of_birth]': {
           	  required: "#fs_driver:visible"	
           	},
           	/*'pickup_place_value': {
           	  required: "#fs_driver:visible"	
           	},
           	'return_place_value': {
           	  required: "#fs_driver:visible"	
           	},*/
           	'conditions_read' : 'required'
           	
           },
           
           messages : {
           	
           	'booking[number_of_adults]' : '<%=t.new_booking.guests_limit(t.booking_items[booking_item_type.to_sym])%>',
            'booking[number_of_children]' : '<%=t.new_booking.guests_limit(t.booking_items[booking_item_type.to_sym])%>',           	
            'booking[customer_name]': '<%=t.new_booking.customer_name.required%>',
           	'booking[customer_surname]' : '<%=t.new_booking.customer_surname.required%>',
           	
           	'booking[customer_email]' : {
           	   required: '<%=t.new_booking.customer_email.required%>',
           	   email: '<%=t.new_booking.customer_email.format%>'
           	},
           	
           	'booking[customer_email_confirmation]': {
           	  'required': '<%=t.new_booking.customer_email_confirmation.required%>',	
           	  email: '<%=t.new_booking.customer_email_confirmation.format%>',
           	  'equalTo': '<%=t.new_booking.customer_email_confirmation.equal_to%>'
           	},
           	
           	'booking[customer_phone]': {
           	  'required': '<%=t.new_booking.customer_phone.required%>',
           	  'minlength': '<%=t.new_booking.customer_phone.min_length%>'	
           	}, 
           	'booking[driver_date_of_birth]': {
           	  'required': '<%=t.new_driving_booking.driver_date_of_birth.required%>'	
           	},       	
           	'booking[pickup_place]': {
           	  'required': '<%=t.new_booking.pickup_place.required%>'	
           	},
           	'booking[return_place]': {
           	  'required': '<%=t.new_booking.return.required%>'	
           	},
           	'conditions_read': '<%=t.new_booking.conditions.required%>'
           	
           },
        
           errorPlacement: function (error, element) {
           	  
           	  if (element.attr('name') == 'conditions_read' || 
           	  	  element.attr('name') == 'booking[number_of_adults]' ||
           	  	  element.attr('name') == 'booking[number_of_children]' )
           	  {
           	    error.insertAfter(element.parent()); 
           	  }
           	  else
           	  {
           	    error.insertAfter(element);
           	  }
           	  
           },
           
           errorClass : 'form-reservation-error'            
                   
         }
        );
       	
        $('#form-payment').validate({

          submitHandler : function(form) {
         	
            $('#payment_error').html('');
            var bookingData = $('#form-reservation').formParams(false);
            var paymentData = $(form).formParams(false);
            for (item in paymentData) {
              if (item == 'booking') {
              	for (bookingItem in paymentData.booking) {
                  bookingData.booking[bookingItem] = paymentData.booking[bookingItem];	
                } 
              }
              else {
              	bookingData[item] = paymentData[item];
              }
            }
            bookingController.confirm_booking(bookingData);
         	return false;
          },

          invalidHandler : function (form, validator) {
            $('#payment_error').html('<%=t.new_booking.form_errors.description%>');
          },
  
          rules : {
        	'booking[payment_method_id]' : {
        		required: true
        	}
          },

          messages : {
        	'booking[payment_method_id]': {
        		required: '<%=t.new_booking.payment_method.required%>'
        	}
          },

       	  errorPlacement : function(error, element) {
       	    	
       	  	if (element.attr('name') === 'booking[payment_method_id]') {
       	   	  error.insertAfter('#payment_methods');
       	   	}          
          
          }

        });

       },
              
       show_prices : function() { /* Show search result */

         var container = $('#result');
      
         // Unbind the previous click handlers
         $('.book-button').unbind('click');
      
      
         container.empty();
      
         var prices = bookingModel.all_prices;
      
         // Puts the prices      
         for (var family in prices) 
         {
      	
      	   var content =
      	      '<div class="container_12">'+	     	
      	        '<div itemscope itemtype="http://schema.org/Product" class="bottom-space bottom-separator car '+family+'">' +
      	          '<div class="grid_3">' +
      	            '<img itemprop="image" src="/img/clase-'+family+'-big.png"/>' +
      	          '</div>' +
      	          '<div class="grid_3 top-margin">' +
      	            '<div class="car_detail_description"><span class="car_family_description" itemprop="name">'+bookingDataSystem.families[family].description+'</span></div>' +
      	            '<div class="car_detail_cars"><span class="car_family_cars" itemprop="description">'+bookingDataSystem.families[family].cars+'</span></div>'+
      	          '</div>';
     	   if (bookingDataSystem.optionals) {
      	     content += '<div class="grid_6">';
             for (var option in bookingDataSystem.optionals) {
             	content += 
             	  '<div class="car_price_optional" itemprop="offers" itemscope itemtype="http://schema.org/Offer">'+
             	    '<div class="car_price_optional_text" itemprop="name">' + bookingDataSystem.optionals[option].name + '</div>' +
                    '<div class="car_price_total"><span itemprop="price">' + prices[family][option].toFixed(bookingDataSystem.configuration.roundDecimals || 0) + '€' + '</span></div>' +
                    '<div class="car_price_booking"><input type="button" class="form-button book-button" id="button_start_booking_'+family+'" value="<%=t.new_booking.booking%>" rel="'+family+'" data-optional="'+ option + '" /></div>' +     	          
      	          '</div>';
             }
             content += '</div>' + 
                '</div>';
      	   }
      	   else {      
    	     content += '<div class="grid_6" itemprop="offers" itemscope itemtype="http://schema.org/Offer">'+
                    '<div class="car_price_total"><span itemprop="price">'+prices[family].toFixed(bookingDataSystem.configuration.roundDecimals || 0) + '€' + '</span></div>' +
                    '<div class="car_price_booking"><input type="button" class="form-button book-button" id="button_start_booking_'+family+'" value="<%=t.new_booking.booking%>" rel="'+family+'" /></div>' +     	          
      	        '</div>'+
      	      '</div>';
           }
      	      	     	
           container.append( content ); 
                     	
         }
       	 
       	 $('.book-button').bind('click', function() { bookingController.start_booking($(this).attr('rel'), $(this).attr('data-optional')); }); // configure the events
       	 
       },
       
       /* ---- Load the items in the combo ---- */
       
       load_items : function() {
       
          var comboItems = document.getElementById('booking[item_id]');
          
          // Remove the options
          if (comboItems.options.length > 0)
          {
          	while (comboItems.hasChildNodes())
          	{
          	  comboItems.removeChild(comboItems.firstChild);	
          	}
          }
          
          // Add the new options
          
          for (var item_class in bookingModel.all_prices)
          {
            if (bookingDataSystem.optionals) {
              for (var optional in bookingDataSystem.optionals) {
                var optionItem = document.createElement('option');
                optionItem.setAttribute('value', item_class);
                optionItem.setAttribute('data-item', item_class);
                optionItem.setAttribute('data-optional', optional);	
                optionItem.text = optionItem.innerText = bookingDataSystem.families[item_class].description + ' (' + bookingDataSystem.optionals[optional].abbr + ')' + ' ... ' + 
                  bookingModel.all_prices[item_class][optional] + ' €';
                if (bookingModel.booking.item_id == item_class && bookingModel.booking.optional == optional)
                {
                  optionItem.selected = true;	
                }
                comboItems.appendChild(optionItem);
              }
            }
            else {        
              var optionItem = document.createElement('option');
              optionItem.setAttribute('value', item_class);	
              optionItem.text = optionItem.innerText = bookingDataSystem.families[item_class].description + ' : ' + bookingModel.all_prices[item_class] + ' €';
              if (bookingModel.booking.item_id == item_class)
              {
                optionItem.selected = true;	
              }
              comboItems.appendChild(optionItem);
            }
          }
       },
       
       /* ------ Load the extras -------------------- */
       
       load_extras : function() {
       
         var extrasHtml = '';
         var extras = bookingDataSystem.extras;
         
         for (extra in extras) {
       	   extrasHtml += tmpl('script_extras', {extra: extras[extra], optional: bookingModel.booking.optional});
         }	
         
         $('#tblextras tbody').html(extrasHtml);
       	 $('.extra').bind('click', 
       	   function() { 
       	   	  var control = '#' + $(this).attr('rel').replace(/\[/g,'\\[').replace(/\]/g,'\\]');
       		  if ($(this).is(':checked')) 
       		  {    		  	
       		  	var value = parseInt($(control).val()) || 1;
       		  	bookingController.check_extra($(this).val(), value);
       		    if ($(control)){
       		      $(control).val(value.toString());	
       		    }
       		  }
       		  else
       		  {
       		  	bookingController.uncheck_extra($(this).val());
       		  	if ($(control)) {
       		  	  $(control).val('0');
       		  	}
       		  } 
       		}
       		);
       	 $('.extraquantity').bind('change',
       	   function() {
       	   	 bookingController.change_extra_quantity($(this).attr('rel'), $(this).val());
       	   }
       	 );       
       	
       },
       
       /* ------ Load pickup places ------ */
       load_pickup_places : function() {

          var comboItems = document.getElementById('pickup_place');
          
          if (comboItems == null) {
            return;
          }  

          // Remove the options
          if (comboItems.options.length > 0)
          {
          	while (comboItems.hasChildNodes())
          	{
          	  comboItems.removeChild(comboItems.firstChild);	
          	}
          }
          
          // Add the new options
          
          for (var pickup_place_id in bookingModel.pickup_places)
          {
              var optionItem = document.createElement('option');
              optionItem.setAttribute('value', pickup_place_id);	
              optionItem.text = optionItem.innerText = bookingDataSystem.pickup_places[pickup_place_id];
              comboItems.appendChild(optionItem);
          }

          // stores the pick up place in the form
          $('#pickup_place_value').val($('#pickup_place option:selected').text());

       },

       /* ------ Load return places -------- */

       load_return_places : function() {

          var comboItems = document.getElementById('return_place');
          
          if (comboItems == null) {
            return;
          }  

          // Remove the options
          if (comboItems.options.length > 0)
          {
          	while (comboItems.hasChildNodes())
          	{
          	  comboItems.removeChild(comboItems.firstChild);	
          	}
          }
          
          // Add the new options
          
          for (var return_place_id in bookingModel.return_places)
          {
              var optionItem = document.createElement('option');
              optionItem.setAttribute('value', return_place_id);	
              optionItem.text = optionItem.innerText = bookingDataSystem.return_places[return_place_id];
              comboItems.appendChild(optionItem);
          }

          // stores the pick up place in the form
          $('#return_place_value').val($('#return_place option:selected').text());

       },

       /* ------ Reflect the state change ----------- */
       
       state_changed : function(new_state) {
       	
       	 switch (new_state) {
       	 	
       	   case 'item_selection' : /* First state (begin process) */
       	     this.load_pickup_places();
       	     this.load_return_places();
       	     break;
       	        
           case 'extras_selection' : /* Second state (user choose an item and starts bookin) */
       	     this.update_information('booking_data');      	               	   
       	     this.load_items();
       	     this.load_extras();
             break;

       	   case 'completing_booking' : /* Third state (user choose an item and starts booking) */
/*       	 this.update_information('booking_data');      	               	   
       	     this.load_items();
       	     this.load_extras();
       	     this.load_pickup_places();
       	     this.load_return_places();
*/
       	     break;


           case 'continue_booking' : /* Alternative state (user comes back to complete booking) */
             break;
          
           case 'pay_booking': /* Go to payment tab */
             this.showPaymentSummary();
             break;
       	 	
       	   case 'sending_booking' : /* Sending the booking using Ajax (user clicks confirm button) */
       	     $('#sending-booking').dialog('open');
       	     break;
       	    
       	   case 'process_completed' : /* The booking has been saved in the system */
       	     $('#sending-booking').dialog('close');   
             if (typeof(bookingModel.confirmBookingResponse) == 'string') {
               document.write(bookingModel.confirmBookingResponse);	
               return;
             }
       	     break;
       	    
       	    case 'process_error' : /* The booking has not been saved in the system */
       	      $('#sending-booking').dialog('close');
              $('<div title="<%=t.new_booking.booking_creation_error.title%>"> <%=t.new_booking.booking_creation_error.description%> </div>').dialog( { height: 260, modal: true,     	 
       	        buttons: {
       	            Ok: function() {
				     $(this).dialog("close");
				  }
				},
				close : function(event, ui) {
				   	$( this ).dialog( "close" );				
				}
           	  });       	           	  
       	      break;
       	 }
       	 
   	     this.wizard.state_changed(new_state);
       	
       },
       
       configurePaymentMethods: function() {
          
          var paymentMethodsDS = new RemoteDataSource('/paymethods', 
          	{id:'id', description: function(data){
          	  var img = (data.icon && data.icon.length > 0)?'<img src="'+ data.icon + '"/>':'';	
          	  img += '<span class="highlighted_text">' + 
          	    data.title +'</span><div class="lighter_text">' + data.description + '</div>';
          	  return img;} 
          	});
          
          var paymentMethods = new ListSelector('payment_methods_selector',
          	'booking[payment_method_id]', paymentMethodsDS, null, false);

       },

       showPaymentSummary : function() {

          var summary = tmpl('script_booking_summary', 
          	{date_from: $('#date_from_extended').val(), 
          	 date_to: $('#date_to_extended').val(),
          	 item: bookingDataSystem.families[bookingModel.booking.item_id].description,
          	 booking: bookingModel.booking,
          	 configuration: bookingDataSystem.configuration,
          	 priceSummary : tmpl('script_detailed_price', {booking: bookingModel.booking, 
                            bookingDataSystem: bookingDataSystem})
            });
          
          $('#booking_summary').html(summary);

       },

       /* --------- UPDATE DATA ---------------- */	 
       update_information : function(information) {
       	
       	 switch (information) {
       	 	
       	   case 'booking_data' :
       	     var date_time_from = new Date(bookingModel.booking.date_from).toString( "dddd, d MMMM yyyy");
       	     if (bookingDataSystem.configuration.show_time) {
       	       date_time_from += ' ' +bookingModel.booking.time_from;	
       	     }
       	     var date_time_to = new Date(bookingModel.booking.date_to).toString( "dddd, d MMMM yyyy");
       	     if (bookingDataSystem.configuration.show_time) {
       	       date_time_to +=  ' ' +bookingModel.booking.time_to;
       	     }
       	     $('#date_from_extended').val( date_time_from );  
       	     $('#date_to_extended').val( date_time_to );
             $('#pickup_place_extended').val( bookingModel.booking.pickup_place );
             $('#return_place_extended').val( bookingModel.booking.return_place );

       	   case 'booking_item' :
       	     var path='/img/clase-'+bookingModel.booking.item_id+'-big.png';
       	     $('#item_image').attr('src',path);

       	   case 'booking_cost' :
       	     $('#total_cost').val( bookingModel.booking.total_cost.toFixed(0) + '€' );
       	     //$('span.total_cost').html( bookingModel.booking.total_cost.toFixed(0) + ' €' );
       	     $('#detailed_summary').html( 
       	      tmpl('script_detailed_price', {booking: bookingModel.booking, 
                            bookingDataSystem: bookingDataSystem}) );
       	     break;
       	   
           case 'optional':
             var extras = bookingDataSystem.extras;
             for (extra in extras) { //Hide the not accepted extras
             	if (!extras[extra].optionalAccepted(bookingModel.booking.optional)) {
             	  $('#booking_extra_'+extra).hide();	
             	}
             	else {
             	  $('#booking_extra_'+extra).show();	
             	}
             }
             break;

       	   case 'booking_extras' :
       	         	            	  
               // Uncheck the removed extras
               $('.extra').each( function(index, element) {
               	if ($(this).is(':checked') && bookingModel.booking.booking_extras[$(this).attr('value')] == null) {
               	  $(this).attr('checked', false);
               	}
               });  
               
               // Update the extras
         	   var extras = bookingModel.booking.booking_extras;
       	       for (var extra_id in extras) {
       	  	     
       	  	     // Extras checkbox
       	  	     var checkbox = $('#extras\\['+extra_id+'\\[extra_id\\]\\]');
       	  	    
       	  	     if (!checkbox.is(':checked')) {
       	  	     	checkbox.attr('checked', true);
       	  	     }
       	  	 
       	  	     // Extras quantity
       	  	     var option = $('#extras\\['+extra_id+'\\[quantity\\]\\]');
       	  	     
       	  	     if (option.val() != extras[extra_id].quantity)
       	  	     {
       	  	       option.val(extras[extra_id].quantity);	
       	  	     }       	  	     
       	  	     
        	   }
        	           	     
        	   /* Update the cost */
       	       this.update_information('booking_cost');
       	       break;
       	 	
       	 }
       	
       },	 
       	    	   	    
       	    	   	    
       wizard : {
       	
       	 tabs : { 
       	 	       'tab-choose-item' : new WizardTab ('tab-choose-item', true),
       	 	       'tab-choose-extras' : new WizardTab ('tab-choose-extras', true),
       	 	       'tab-complete-reservation' : new WizardTab('tab-complete-reservation', true),
       	 	       'tab-payment' : new WizardTab('tab-payment', <%= booking_payment %>)
       	        },
       	       
       	 state_changed : function (new_state) {
       	 
       	   switch (new_state) {
       	   	
       	   	  case 'item_selection' : /* Item selection tab */
       	        $('#form-reservation').hide();
       	        $('#item-selection').show();
       	        $('#extras-selection').hide();
       	        $('#booking-payment').hide();
       	   	    this.tabs['tab-choose-item'].setState('active'); 
       	   	    this.tabs['tab-choose-extras'].setState('not-enabled'); 
       	   	    this.tabs['tab-complete-reservation'].setState('not-enabled');
       	   	    this.tabs['tab-payment'].setState('not-enabled');
       	   	    break;
       	   	  
              case 'extras_selection': /* Extras selection tab */
                $('#form-reservation').hide();
                $('#item-selection').hide();
                $('#extras-selection').show();
                $('#booking-payment').hide();
       	   	    this.tabs['tab-choose-item'].setState('not-enabled'); 
       	   	    this.tabs['tab-choose-extras'].setState('active'); 
       	   	    this.tabs['tab-complete-reservation'].setState('not-enabled');
       	   	    this.tabs['tab-payment'].setState('not-enabled');
                break;

       	   	  case 'completing_booking' : /* Complete booking data tab */
       	   	  case 'continue_booking' :
       	        $('#item-selection').hide();
       	        $('#extras-selection').hide();       	        
                $('#form-reservation').show();
       	   	    $('#booking-payment').hide();
       	   	    this.tabs['tab-choose-item'].setState('not-enabled'); 
       	   	    this.tabs['tab-choose-extras'].setState('not-enabled');       	   	    
       	   	    this.tabs['tab-complete-reservation'].setState('active');
       	   	    this.tabs['tab-payment'].setState('not-enabled');
       	   	    break;

              case 'pay_booking': /* Payment tab */
                $('#item-selection').hide();
       	        $('#extras-selection').hide();                
                $('#form-reservation').hide();              
                $('#booking-payment').show();
                $('#payment_total').text(bookingModel.booking.total_cost + '€');
                $('#payment_deposit').text(bookingModel.booking.booking_amount + '€');
                if ($('#booking\\[payment_method_id\\]_container').children().length == 0) {
                   $('#payments_methods h3').hide();	
                } 
     	   	    this.tabs['tab-choose-item'].setState('not-enabled'); 
       	   	    this.tabs['tab-choose-extras'].setState('not-enabled');       	   	    
       	   	    this.tabs['tab-complete-reservation'].setState('not-enabled');
       	   	    this.tabs['tab-payment'].setState('active');                
                break;
       	   	  
              case 'process_completed': /* Summary tab */
         	    $('#item-selection').hide();
         	    $('#extras-selection').hide();
         	    $('#form-reservation').hide();
         	    $('#booking-payment').hide();
		       	var data = $('#form-reservation').formParams(false);
		       	data.bookingConfiguration = bookingDataSystem.configuration;   
		       	var message = tmpl('script_booking_finished', data);
		       	$('#booking-complete-message').html(message);
       	        $('#booking-complete-message').show();
       	        
     	   	    this.tabs['tab-choose-item'].setState('not-enabled');
     	   	    this.tabs['tab-choose-extras'].setState('not-enabled');  
       	   	    this.tabs['tab-complete-reservation'].setState('not-enabled');
       	   	    this.tabs['tab-payment'].setState('not-enabled');  

                break;

       	   }
       	 	
       	 },
       	 
       	 show : function() {
       	 	$('#wizard-navigation').show();
       	 },
       	 
       	 hide: function() {
       	 	$('#wizard-navigation').hide();
       	 }
       	
       }
              	    	   	    
       	    	   	          	
    }
  
    bookingView.init();
  
  });
  </script>
