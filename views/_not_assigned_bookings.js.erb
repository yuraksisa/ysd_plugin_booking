define('confirmedBooking', ['ysdtemplate', 'YSDFormatter', 'jquery'], 
  function(tmpl, ysdFormatter, $) {

  confirmedBookingsModel = {

     data: [],
     filter: 'pending',
     resources: {},

     changeFilter: function(filter) {
       this.filter = filter;
       confirmedBookingsView.update('filter_changed');
     },

     setResources: function(data) {
        this.resources = data;
        if (this.resources != {} && this.data.length > 0) {
          confirmedBookingsView.update('data_available');
        }
     },

     getBookings: function(month, year) {

       var url = '/api/booking/confirmed';
       if (month && year) {
         url += '?month='+month+'&year='+year;
       }

       $.ajax({
               type: 'GET',
               url : url,
               contentType: 'application/json; charset=utf-8',
               dataType : 'json',
               success: function(data, textStatus, jqXHR) {
                  confirmedBookingsModel.data = data;
                  if (confirmedBookingsModel.resources != {} && confirmedBookingsModel.data.length > 0) {
                    confirmedBookingsView.update('data_available');
                  }
              }
          });

     }


  };

  confirmedBookingsController = {

  };

  confirmedBookingsView = {

    init: function() {
      $('#filter').bind('change', function() {
        confirmedBookingsModel.changeFilter($(this).val());
      });
    },

    update: function(event) {

      switch (event) {
        case 'data_available':
          var template = tmpl('script_booking_line');
          var result = '';
          for (var i=0;i<confirmedBookingsModel.data.length;i++) {
             if (confirmedBookingsModel.filter == 'all' || confirmedBookingsModel.data[i].booking_item_reference == null) {
               result += template({entity: confirmedBookingsModel.data[i],
               resources: confirmedBookingsModel.resources[confirmedBookingsModel.data[i].item_id],
               formatter: ysdFormatter});
             }
          }
          $('#elements_tbody').html(result);
          break;
        case 'filter_changed':
          var template = tmpl('script_booking_line');
          var result = '';
          for (var i=0;i<confirmedBookingsModel.data.length;i++) {
             if (confirmedBookingsModel.filter == 'all' || confirmedBookingsModel.data[i].booking_item_reference == null) {
               result += template({entity: confirmedBookingsModel.data[i], 
                  resources: confirmedBookingsModel.resources[confirmedBookingsModel.data[i].item_id],
                  formatter: ysdFormatter});
             }
          }
          $('#elements_tbody').html(result);
          break;
      }

    }

  };

  confirmedBookings = {
      model: confirmedBookingsModel,
      controller: confirmedBookingsController,
      view: confirmedBookingsView
  }

  confirmedBookingsView.init();

  return confirmedBookings;
});