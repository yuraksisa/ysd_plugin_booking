require(['YSDFormatter', 'jquery', 'jquery.ui', 'jquery.ui.datepicker-es', 'jquery.validate',
         'jquery.ui.datepicker.validation','jquery.formparams', 'jquery.fixedtable', 'datejs'], 
        function(YSDFormatter, $) {

  bookingPlanningModel = {
    dateFrom: null,
    dateTo: null,
    product: null,
    reference: null,
    references: null,
    planningData : null,
    selectedReservations: null,
    selectedItemOrigin: null,
    selectedItemOriginAbbr: null,
    selectedItemId: null,
    currentReference: null,
    currentReferenceColor: null,
    newReference: null,
    scrollTop: null,
    scrollLeft: null,
    prereservationCell: null,
    prereservationReference: null,
    mode: 'select-reservation',
    months: ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'],

    loadData: function() {
  	  if (this.dateFrom != null && this.dateTo != null) {
  	    var from = this.dateFrom.toString('yyyy-MM-dd');
  	    var to = this.dateTo.toString('yyyy-MM-dd');
  	    var url = '/api/booking/planning-summary?from='+from+'&to='+to;
  	    if (this.product != null) {
  	      url += '&product='+product;
        }
  	    else if (this.reference != null) {
  	      url += '&reference='+reference;
  	    } 
 	      $.ajax({
  	        type: 'GET',
  	   	    url : url,
  	   	    contentType: 'application/json; charset=utf-8',
  		      dataType : 'json',
  		      success: function(data, textStatus, jqXHR) {
               bookingPlanningModel.references = data.references;
               bookingPlanningModel.planningData = data.result;
               bookingPlanningView.update('data_available');
            },
            error: function(textStatus, jqXHR) {
              alert('Error obteniendo datos del planning');
            }
          });  	 
 	    }
      else {
    	bookingPlanningView.update('not_enough_information');
      }
    },

    loadPendingAssignation: function() { /* Load the pending of assign */

       $('#operation_area').load('/admin/booking/planning2-pending-assignation #pending_assignation_container',
        null,
        function(responseText, textStatus, jqXHR){
          if (jqXHR.status == 200) {
            $('.pending_assign_button').unbind('click');
            $('.pending_assign_button').bind('click', function(){
              var id = $(this).attr('data-id');
              var dateFrom = $(this).attr('data-date-from');
              var dateTo = $(this).attr('data-date-to');
              bookingPlanningController.pendingAssignButtonClick(id, dateFrom, dateTo);
            }); 
          }
          else {
            alert('Error cargando datos');
          }
        });
    

    },

    loadSelectedReservations: function(reference, date) { /* Load the selected reservation */
      bookingPlanningModel.currentReference = reference;
      $('#operation_area').load('/admin/booking/planning2-select?reference='+reference+'&date='+date+' #reservation_selector', null,
        function(responseText, textStatus, jqXHR){
          if (jqXHR.status == 200) {
            if ($('form[name=select_booking]').length > 0) { // More than one candidate
              $('#select_resource').hide();
              $('form[name=select_booking] input[type=radio][name=id]').unbind('change');
              $('form[name=select_booking] input[type=radio][name=id]').bind('change', function(){
                 bookingPlanningController.candidateChange($(this).val(),$(this).attr('rel'));
              });
            }
            else {
              if ($('form[name=reassign_form] input[name=id]').val() != 'undefined') {
                bookingPlanningModel.selectedItemId = $('form[name=reassign_form] input[name=id]').val();
              }
              else {
                bookingPlanningModel.selectedItemId = null;
              }
              if ($('form[name=reassign_form] input[name=origin]').val() != 'undefined') {
                bookingPlanningModel.selectedItemOrigin = $('form[name=reassign_form] input[name=origin]').val();
                if (bookingPlanningModel.selectedItemOrigin == 'booking') {
                  bookingPlanningModel.selectedItemOriginAbbr = 'R';
                }
                else if (bookingPlanningModel.selectedItemOrigin == 'prereservation') {
                  bookingPlanningModel.selectedItemOriginAbbr = 'P';
                }
              }
              else {
                bookingPlanningModel.selectedItemOrigin = null;
              }
              bookingPlanningView.selectReservation(bookingPlanningModel.selectedReservations.substring(0,1),
                                                    bookingPlanningModel.selectedReservations.substring(1));
            }
            $('.color').bind('change', function() {
               var id = $(this).parent().find('input[name=id]').val();
               var type = $(this).parent().find('input[name=type]').val();
               var color =$(this).val();
               bookingPlanningController.changeColorChanged(id, type, color);
            })
            $('.destroy_prereservation_button').bind('click', function() {
               bookingPlanningController.destroyPrereservationClick($(this).attr('rel'));
            })
          }
        });
    },

    reassignResource: function() {
      var url = '/admin/booking/planning-reassign-reservation';
      url+='?id='+this.selectedItemId+'&resource='+this.newReference+'&type='+this.selectedItemOrigin;
      $.ajax({
          type: 'POST',
          url : url,
          success: function(data, textStatus, jqXHR) {
            bookingPlanningModel.currentReference = null;
            bookingPlanningModel.currentReferenceColor = null;
            bookingPlanningModel.newReference = null;
            bookingPlanningModel.mode = 'select-reservation';
            bookingPlanningView.update('reassigned');
          },
          error: function(textStatus, jqXHR) {
            alert('Error reasignando');
          }
      });    
    },

    createPrereservation: function() {
        var formdata = $('form[name="element"]').formParams(true);
        delete formdata.id;
        var json_request = JSON.stringify(formdata);      
        $.ajax({
               type: 'POST',
               data : json_request,
               url : '/api/booking-prereservation',
               success: function(data, textStatus, jqXHR) {
                 bookingPlanningModel.prereservationCell = null;
                 bookingPlanningModel.prereservationReference = null;
                 bookingPlanningView.update('created_prereservation');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error creando prereserva');
               }
           });       
    },

    destroyPrereservation: function(id) {
      var url = '/admin/booking/planning-remove-prereservation';
      url+='?id='+id;
      $.ajax({
          type: 'POST',
          url : url,
          success: function(data, textStatus, jqXHR) {
            bookingPlanningModel.currentReference = null;
            bookingPlanningModel.currentReferenceColor = null;
            bookingPlanningModel.newReference = null;
            bookingPlanningModel.mode = 'select-reservation';
            bookingPlanningView.update('destroyed_preservation');
          },
          error: function(textStatus, jqXHR) {
            alert('Error eliminando prereserva');
          }
      });          
    },

    changeColor: function(id, type, color) {
      var url = '/admin/booking/planning-change-color';
      url+='?id='+id+'&type='+type+'&color='+escape(color);
      $.ajax({
          type: 'POST',
          url : url,
          success: function(data, textStatus, jqXHR) {
            bookingPlanningView.update('changed_color');
          },
          error: function(textStatus, jqXHR) {
            alert('Error eliminando prereserva');
          }
      });       
    }

  }

  bookingPlanningController = {
 
    loadPendingAssignationClick: function() { /* The user clicks on a see reservations not assigned */
       bookingPlanningModel.loadPendingAssignation();
    },

    pendingAssignButtonClick: function(id, dateFrom, dateTo) { /* The user clicks on assign button (reservations not assigned) */

       $('.pending_assign_row').css('background-color', 'white');
       $('.pending_assign_row[rel='+id+']').css('background-color', 'yellow');
       bookingPlanningView.update('notification', 'Seleccionar el recurso a asignar');
       bookingPlanningModel.selectedItemId = id;
       bookingPlanningModel.selectedItemOrigin = 'booking';
       bookingPlanningModel.selectedItemOriginAbbr = 'R';
       $('#select_resource').show();
       var date = new Date(dateFrom);
       var dateTo = new Date(dateTo);
       $('th.date_header').css('background','#EEE');
       $('th.date_header').css('color','black');
       while (date <= dateTo) {
         var strDate = YSDFormatter.formatDate(date,'yyyy-MM-dd');
         $('th.date_header[rel='+strDate+']').css('background','black');
         $('th.date_header[rel='+strDate+']').css('color','white');
         date.addDays(1);
       }
       var firstDay = YSDFormatter.formatDate(dateFrom,'yyyy-MM-dd');
       $('#parent').animate({
        scrollLeft: $('th.date_header[rel='+firstDay+']').position().left -
                    $('#parent').offset().left
       }, 2000);
       bookingPlanningController.startResourceSelectionClick();
    },

    dataFilledClick: function(reference, date, selectedReservations) {

      if ($('#preresevation_area:visible')) {
        $('#prereservation_container').hide();
        $('#operation_area').show();
      }

      if (bookingPlanningModel.prereservationCell != null) {
        $(bookingPlanningModel.prereservationCell).css('background-color', 'white');
        bookingPlanningModel.prereservationCell = null;
      }
      if (bookingPlanningModel.prereservationReference != null) {
        $($('#'+bookingPlanningModel.prereservationReference).children()[0]).css('background-color','white');
        bookingPlanningModel.prereservationReference = null;
      }

      if (bookingPlanningModel.mode == 'select-reservation') {
        if (bookingPlanningModel.selectedItemId != null) {
          var element = $("td[rel~="+"'"+bookingPlanningModel.selectedItemOriginAbbr+bookingPlanningModel.selectedItemId+"'"+"]");
          element.removeClass('selected');
          $(element.parent().children()[0]).css('background-color','white');
        }
        bookingPlanningModel.selectedReservations = selectedReservations;
        bookingPlanningModel.loadSelectedReservations(reference, date);
      }

    },

    dataEmptyClick: function(theElement, reference, date) { /* Click on an empty cell: New prereservation */

      if (bookingPlanningModel.selectedItemId != null) {
        var element = $("td[rel~="+"'"+bookingPlanningModel.selectedItemOriginAbbr+bookingPlanningModel.selectedItemId+"'"+"]");
        element.removeClass('selected');
        $(element.parent().children()[0]).css('background-color','white');        
      }
      
      if (bookingPlanningModel.prereservationCell != null) {
        $(bookingPlanningModel.prereservationCell).css('background-color', 'white');
        bookingPlanningModel.prereservationCell = null;
      }

      if (bookingPlanningModel.prereservationReference != null) {
        $($('#'+bookingPlanningModel.prereservationReference).children()[0]).css('background-color','white');
      }

      bookingPlanningModel.prereservationCell = theElement;
      $(bookingPlanningModel.prereservationCell).css('background-color', 'yellow');
      
      bookingPlanningModel.prereservationReference = reference;
      $($('#'+reference).children()[0]).css('background-color','yellow');

      $('#prereservation_button').unbind('click');
      $('#prereservation_button').bind('click', function(){
        if ($('#prereservation_form').valid()) {
          bookingPlanningController.prereservationButtonClick();
        }
      });

      $('#cancel_prereservation_button').unbind('click');
      $('#cancel_prereservation_button').bind('click', function(){
        bookingPlanningController.cancelPrereservationButtonClick();
      });

      $('#booking_item_reference_value').html(reference);
      $('form[name=element] input[name=booking_item_reference]').val(reference);
      
      // Setup the form
      var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];
      $('#date_from').datepicker({
            numberOfMonths:1}, 
            locale);
      $('#date_to').datepicker({
            numberOfMonths:1}, 
            locale);
      $('#date_from').bind('change', function() {
           var dateFrom = $('#date_from').datepicker('getDate'); 
           var dateTo = $('#date_to').datepicker('getDate');
           if (dateTo != null) {
             dateTo.setDate(dateFrom.getDate() + <%=@product_family.cycle_of_24_hours ? 1 : 0%>);
           }
           $('#date_to').datepicker('setDate', dateTo );
           $('#date_to').datepicker('option', 'minDate', dateFrom.add(<%=@product_family.cycle_of_24_hours ? 1 : 0%>).days());
         });
      $('#date_from').datepicker('setDate', new Date(date));
      $('#date_from').trigger('change');

      $.validator.addMethod("time24", function(value, element) {
        if (!/^\d{2}:\d{2}$/.test(value)) {
          return false;
        } 
        var parts = value.split(':');
        if (parseInt(parts[0]) > 23 || parseInt(parts[1]) > 59) {
          return false;
        } 
        return true;
      }, "Invalid time format. The format is hh:mm");

      $('#prereservation_form').validate({

            submitHandler: function(form) 
            {
              return false;
            },        

            rules : {
               'date_from': {
                 required: true 
               },
             
               'date_to': {
                 required: true,
                 dpCompareDate : { 'notLessThan' : '#date_from'} 
               },

               'title': {
                 required: true
               }

               <% if @product_family.time_to_from %>
               ,
               'time_from': {
                 required: true,
                 time24: true
               },
               'time_to': {
                 required: true,
                 time24: true
               }

               <% end %>
            
            },
            
            messages : {
              
               'date_from': {
                 required : '<%=t.bookings_planning.prereservation.validation.date_from_required%>'
               }, 
              
               'date_to' : {
                 required : '<%=t.bookings_planning.prereservation.validation.date_to_required%>',
                 dpCompareDate : '<%=t.bookings_planning.prereservation.validation.date_to_greater_date_from%>'
               },

               'title': {
                 required: '<%=t.bookings_planning.prereservation.validation.title_required%>'
               }    
               <% if @product_family.time_to_from %>
               ,
               'time_from': {
                 required: '<%=t.bookings_planning.prereservation.validation.time_from_required%>',
                 time24: '<%=t.validations.time_format_invalid%>'
               },
               'time_to': {
                 required: '<%=t.bookings_planning.prereservation.validation.time_to_required%>',
                 time24: '<%=t.validations.time_format_invalid%>'
               }
               <% end %>
            }

      });

      // Show prereservation form
      $('#operation_area').hide();
      $('#prereservation_container').show();
    },

    prereservationButtonClick: function() {
       bookingPlanningModel.createPrereservation();
    },

    cancelPrereservationButtonClick: function() {
      if (bookingPlanningModel.prereservationCell != null) {
        $(bookingPlanningModel.prereservationCell).css('background-color', 'white');
        bookingPlanningModel.prereservationCell = null;
      }
      if (bookingPlanningModel.prereservationReference != null) {
        $($('#'+bookingPlanningModel.prereservationReference).children()[0]).css('background-color','white');
        bookingPlanningModel.prereservationReference = null;
      }      
      $('#prereservation_container').hide();       
      $('#operation_area').show();
      $('form[name=element]')[0].reset();
    },

    destroyPrereservationClick: function(id) { /* Destroy preresevation */
      
      bookingPlanningModel.destroyPrereservation(id);

    },

    changeColorChanged: function(id, type, color) { /* Change planning color */

      bookingPlanningModel.changeColor(id, type, color);

    },


    candidateChange: function(id, origin) { /* Select candidate */
      if (bookingPlanningModel.selectedItemId != null) {
        var element = $("td[rel~="+"'"+bookingPlanningModel.selectedItemOriginAbbr+bookingPlanningModel.selectedItemId+"'"+"]");
        element.removeClass('selected');
        $(element.parent().children()[0]).css('background-color','white');        
      }
      setTimeout(function() {
        bookingPlanningModel.selectedItemId = id;
        bookingPlanningModel.selectedItemOrigin = origin;
        if (bookingPlanningModel.selectedItemOrigin == 'booking') {
          bookingPlanningModel.selectedItemOriginAbbr = 'R';
        }
        else if (bookingPlanningModel.selectedItemOrigin == 'prereservation') {
          bookingPlanningModel.selectedItemOriginAbbr = 'P';
        }        
        bookingPlanningView.selectReservation(bookingPlanningModel.selectedItemOriginAbbr,
                                              bookingPlanningModel.selectedItemId);
        $('#select_resource').show();
      }, 200);
    },

    startResourceSelectionClick: function() { /* Start the resource selection */
      bookingPlanningModel.mode= 'select-resource';
      $('#select_resource_button').hide();
      $('#cancel_select_resource_button').show();
      $('#cancel_select_resource_button').css('display', 'block');
      $('#cancel_select_resource_button').unbind('click');
      $('#cancel_select_resource_button').bind('click', function() {
        bookingPlanningController.cancelResourceSelectionClick();
      });
      $(".data").unbind('click');
      $(".data").bind('click', function() {
        bookingPlanningController.selectResourceClick($(this).parent().attr('id'));
      })
    },

    cancelResourceSelectionClick: function() { /* Cancel the resource selection */
      bookingPlanningModel.mode = 'select-reservation';
      $('#cancel_select_resource_button').hide();
      $('#select_resource_button').show();
      $(".data").unbind('click');
      $(".data.empty").bind('click', function(event) {
        var theElement = $(this);
        bookingPlanningController.dataEmptyClick(theElement,
                                                 $(this).parent().attr('id'), 
                                                 $(this).attr('data-date'));
      });
      $(".data.filled").bind('click', function(event) {
        bookingPlanningController.dataFilledClick($(this).parent().attr('id'), 
                                                  $(this).attr('data-date'),
                                                  $(this).attr('rel'));
      });   
      var resource = $('form[name=reassign_form] input[name=resource]').val();
      $($('#'+resource).children()[0]).css('background-color','white');
      $('#resource').html('');
      $('form[name=reassign_form] input[name=resource]').val('');
      $('#reassign_resource').hide(); 
    },

    selectResourceClick: function(resource) { /* Select the resource */
      if (bookingPlanningModel.newReference != null) {
        $($('#'+bookingPlanningModel.newReference).children()[0]).css('background-color','white');
      }
      $('#original_resource').html(bookingPlanningModel.currentReference);
      bookingPlanningModel.newReference = resource;
      $('#resource').html(resource);
      $('form[name=reassign_form] input[name=resource]').val(resource);
      $('#reassign_resource').show();
      $($('#'+resource).children()[0]).css('background-color','yellow');
      $('#reassign_button').unbind('click');
      $('#reassign_button').bind('click', function(){
        bookingPlanningController.reassignButtonClick();
      });
    },

    reassignButtonClick: function() {
      bookingPlanningModel.reassignResource();
    }


  }

  bookingPlanningView = {

    init: function() {
      $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );
      bookingPlanningModel.loadData();
      $('#parent').scroll(function (event) {
      	if ($(this).scrollLeft() == 0) {
      	  // Start reached (request for data)
      	}
        if($(this).scrollLeft() + $(this).innerWidth() >= $(this)[0].scrollWidth) {
          // End reached (request for data)
        }
      });
      $('#assign_pending_button').bind('click', function(){
        bookingPlanningController.loadPendingAssignationClick();
      });
    },
    update: function(event, value) {
  	  switch (event) {
  		case 'data_available':
  		  if ($('#planning_table tbody').children().length == 0) {
  		  	$("#planning_table thead").append("<tr></tr>");
  		  	$("#planning_table thead tr:first").append("<th style='min-width:120px'>"+'RECURSOS'+"</th>");
  		  	for (item in bookingPlanningModel.references) {
  		  	  $("#planning_table tbody").append("<tr id='" + item + "' rel='" + bookingPlanningModel.references[item] + "'></tr>");
  		  	  $("#planning_table tbody tr#"+item+"").append("<td>"+bookingPlanningModel.references[item] + '-' + item+"</td>");
  		  	}
  		  }
  		  for (item in bookingPlanningModel.planningData) {
  		  	var date = new Date(item);
  		  	var title = date.getDate() + ' ' + bookingPlanningModel.months[date.getMonth()];
          var datestr = YSDFormatter.formatDate(date, 'yyyy-MM-dd');
            $("#planning_table thead tr:first").append("<th class='date_header' rel='" + datestr + "'>"+title+"</th>");
            for (resource in bookingPlanningModel.planningData[item]) {
              var value = '';
              if (bookingPlanningModel.planningData[item][resource].total == 1) {
                value = 'X';
              }
              else if (bookingPlanningModel.planningData[item][resource].total > 1) {
                value = bookingPlanningModel.planningData[item][resource].total;
              }
              
              var background = 'white';
              if (bookingPlanningModel.planningData[item][resource].detail.length > 0) {
                background = bookingPlanningModel.planningData[item][resource].detail[0].planning_color;
              }
              var cellInformation = "style='background:" + background + "'";
              cellInformation += " data-date='" + item + "' ";              
              if (value == '') {
                cellInformation += " class='data empty' "; 
              }
              else {
                cellInformation += " class='data filled' ";
              }
              var summary = bookingPlanningModel.planningData[item][resource].summary;
              if (summary != null) {
                cellInformation += " title='" + summary + "'";
              }              
              var reservationIds = bookingPlanningModel.planningData[item][resource].reservation_ids;
              var preReservationIds = bookingPlanningModel.planningData[item][resource].prereservation_ids;
              
              if (reservationIds != null) {
                var reservationsArray = reservationIds.split(' ');
                for (var idx=0;idx<reservationsArray.length;idx++) {
                  reservationsArray[idx] = 'R'+reservationsArray[idx];
                }
                reservationIds = reservationsArray.join(' ');
              }
              if (preReservationIds != null) {
                var preReservationsArray = preReservationIds.split(' ');
                for (var idx=0;idx<preReservationsArray.length;idx++) {
                  preReservationsArray[idx] = 'P'+preReservationsArray[idx];
                }
                preReservationIds = preReservationsArray.join(' ');
              }

              var ids = null;
              if (reservationIds != null) {
                ids = reservationIds;
              }
              if (preReservationIds != null) {
                if (ids == null) {
                  ids = preReservationIds;
                }
                else {
                  ids += ' ';
                  ids += preReservationIds;
                }
              }
              if (ids != null) {
                cellInformation += " rel='" + ids + "'";
              }
              $("tr#"+resource).append("<td " + cellInformation + ">"+value+"</td>");	
            }
  		  }
  		  
        $("#planning_table").tableHeadFixer({"left" : 1});
        $(".data").unbind('click');
        $(".data.empty").bind('click', function(event) {
          var theElement = $(this);
          bookingPlanningController.dataEmptyClick(theElement,
                                                   $(this).parent().attr('id'), 
                                                   $(this).attr('data-date'));
        });        
        $(".data.filled").bind('click', function(event) {
          bookingPlanningController.dataFilledClick($(this).parent().attr('id'),
                                                    $(this).attr('data-date'),
                                                    $(this).attr('rel'));
        }); 		 
        
        if (bookingPlanningModel.scrollLeft != null) {
          $('#parent').scrollLeft(bookingPlanningModel.scrollLeft);
        }
        if (bookingPlanningModel.scrollTop != null) {
          $('#parent').scrollTop(bookingPlanningModel.scrollTop);
        }

  		  break;

      case 'notification':
        $('#notification_container').html(value);
        if (value == '') {
          $('#notification_container').hide();
        }
        else {
          $('#notification_container').show();
        }
        break;

      case 'reassigned':
        this.reload();
        break;

      case 'created_prereservation':
        $('#prereservation_container').hide();
        $('#operation_area').show();
        $('form[name=element]')[0].reset();
        this.reload();
        break;

      case 'destroyed_preservation':
        this.reload();
        break;

      case 'changed_color':
        this.reload();
        break;

  		case 'not_enough_information':
  		  alert('No hay suficientes datos para obtener la información');
  		  break;
  	  }
    },

    reload: function() { /* Reload the data */
        bookingPlanningModel.scrollLeft = $('#parent').scrollLeft();
        bookingPlanningModel.scrollTop = $('#parent').scrollTop();
        $('#planning_table thead').empty();
        $('#planning_table tbody').empty();
        $('#operation_area').empty();
        bookingPlanningModel.loadData();
    },

    selectReservation: function(origin, id) {   
      bookingPlanningView.selectCurrentResource( $("td[rel~="+"'"+origin+id+"'"+"]"));
      $('#select_resource_button').unbind('click');
      $('#select_resource_button').bind('click', function() {
        bookingPlanningController.startResourceSelectionClick();
      });
    },

    selectCurrentResource: function(element) {
    
      bookingPlanningModel.currentReferenceColor = element.css('background-color');
      if (bookingPlanningModel.currentReferenceColor == 'rgba(0, 0, 0, 0)' || 
          bookingPlanningModel.currentReferenceColor == 'transparent') {
        bookingPlanningModel.currentReferenceColor = '#EEEEEE';
      }
      var lastStyleSheet = document.styleSheets[document.styleSheets.length - 1];
      var rule = '@keyframes selected {\
                  from { background-color:'+ bookingPlanningModel.currentReferenceColor +'; }\
                  to { background-color: white; }\
                  }';
      lastStyleSheet.insertRule(rule, lastStyleSheet.cssRules.length);      
      element.addClass('selected');
      $(element.parent().children()[0]).css('background-color', bookingPlanningModel.currentReferenceColor);
    }


  }

});  