require(['jquery', 'ysdtemplate', 'datejs', 
         'jquery.ui', 'jquery.ui.datepicker-es'], function($, tmpl) {


  bookingPickedupModel = {

     pickupResult : null,
     returnResult : null,

     loadData: function(dateFrom, dateTo) {

       var strDateFrom = dateFrom.toString("yyyy-MM-dd");
       var strDateTo = dateTo.toString("yyyy-MM-dd");

  	   $.ajax({
  	   	       type: 'GET',
  	   	       url : '/api/booking/pickedup?from='+strDateFrom+'&to='+strDateTo,
  	   	       contentType: 'application/json; charset=utf-8',
  		         dataType : 'json',
  		         success: function(data, textStatus, jqXHR) {
                  bookingPickedupModel.pickupResult = data;
                  bookingPickedupView.update('pickup_data_available');
               }
          });

       $.ajax({
               type: 'GET',
               url : '/api/booking/returned?from='+strDateFrom+'&to='+strDateTo,
               contentType: 'application/json; charset=utf-8',
               dataType : 'json',
               success: function(data, textStatus, jqXHR) {
                  bookingPickedupModel.returnResult = data;
                  bookingPickedupView.update('return_data_available');
               }
          });


     }

  };

  bookingPickupedController = {

    dateFromChanged: function() {

      var dateFrom = $('#date_from').datepicker('getDate'); 
      var dateTo = $('#date_to').datepicker('getDate');
      dateTo.setDate(dateFrom.getDate() + 7);
      $('#date_to').datepicker('setDate', dateTo );
      $('#date_to').datepicker('option', 'minDate', dateFrom.add(7).days());

    },

    dateChanged : function() {

      var dateFrom = $('#date_from').datepicker('getDate');
      var dateTo = $('#date_to').datepicker('getDate');
      
      bookingPickedupModel.loadData(dateFrom, dateTo);

    }

  };

  bookingPickedupView = {

     chart: null,

     init : function() {

         var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];             
         $.datepicker.setDefaults($.datepicker.regional["<%=session[:locale] || 'es'%>"]);

         $('#date_from').datepicker(
                 {controlType: 'select', 
                  showTimezone: false, 
                  useLocalTimezone: true, 
                  numberOfMonths:1, 
                  minDate: new Date(),
                  maxDate: new Date().add(365).days(),
                  dateFormat: 'dd/mm/yy',
                  onSelect: function(dateText) {
                    bookingPickupedController.dateFromChanged();
                    bookingPickupedController.dateChanged();
                  }},
                  locale
                  );
         $('#date_from').datepicker('setDate', '+0');

         $('#date_to').datepicker(
                 {controlType: 'select',
                  showTimezone: false, 
                  useLocalTimezone: true,
                  numberOfMonths:1, 
                  minDate: new Date().add(7).days(),
                  maxDate: new Date().add(365).days(),
                  dateFormat: 'dd/mm/yy',
                  onSelect: function(dateText) {
                    bookingPickupedController.dateChanged();
                  }},
                  locale
                  );         
         $('#date_to').datepicker('setDate', '+7');

     },

     update: function(status) {

        switch(status) {
        	case 'pickup_data_available':
        	  $("#pickedup_booking_data").html(tmpl('pickedup_bookings_table', {data: bookingPickedupModel.pickupResult}));
        	  break;
          case 'return_data_available':
            $("#returned_booking_data").html(tmpl('returned_bookings_table', {data: bookingPickedupModel.returnResult}));
            break;            
        }

       
     }

  };

  bookingPickedupView.init();
  var dateFrom = $('#date_from').datepicker('getDate');
  var dateTo = $('#date_to').datepicker('getDate');
  bookingPickedupModel.loadData(dateFrom, dateTo);

});