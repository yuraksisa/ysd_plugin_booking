<%= partial 'select_customer.js'.to_sym %>

require(['jquery', 'YSDEntityManagement','YSDRemoteDataSource', 'YSDSelectSelector', 
         'YSDForms', 'ysdtemplate', 'YSDGui', 'jquery.validate',
         'jquery.ui', 'jquery.ui.datepicker-es', 'jquery.ui.datepicker.validation',
         'jquery.formparams', 'jquery.ui.timepicker','autonumeric' ],
    function($, EntityManagement, RemoteDataSource, SelectSelector, YSDForms, tmpl,
         YSDGui) {

 
  function BookingHook() {

    this.stockCategory = {};
    this.stockIds = [];
    this.stockDetail = [];

    <% if @addon_sales_channels %>
    this.frontendPrefixes = {
        <% @booking_frontend_prefix_sales_channels.each do |k,v| %>
        '<%=k%>':'<%=v.nil? or v.empty? ? booking_front_end_prefix : v %>',
        <% end %>
    };
    <% end %>

    this.statusDescription = {
       'pending_confirmation' : '<span class="label label-warning"><%= t.booking_status.pending_confirmation%>',
       'confirmed' : '<span class="label label-success"><%= t.booking_status.confirmed%></span>',
       'in_progress' : '<span class="label label-info"><%= t.booking_status.in_progress%></span>',
       'done' : '<span class="label label-primary"><%= t.booking_status.done%></span>',
       'cancelled' : '<span class="label label-danger"><%= t.booking_status.cancelled%></span>'
    }
 	   
    this.paymentStatusDescription = {
       'none' : '<span class="label label-warning"><%= t.booking_payment_status.none%></span>',
       'deposit' : '<span class="label label-primary"><%= t.booking_payment_status.deposit%></span>',
       'total' : '<span class="label label-success"><%= t.booking_payment_status.total%></span>',
       'refunded': '<span class="label label-danger"><%= t.booking_payment_status.refunded%></span>'
    }

    this.statusDescriptionText = {
        'pending_confirmation' : '<span class="btn btn-minw btn-rounded btn-noborder btn-warning push-5" style="font-size:100%"><%= t.booking_status.pending_confirmation%></span>',
        'confirmed' : '<span class="btn btn-minw btn-rounded btn-noborder btn-success push-5" style="font-size:100%"><%= t.booking_status.confirmed%></span>',
        'in_progress' : '<span class="btn btn-minw btn-rounded btn-noborder btn-info push-5" style="font-size:100%"><%= t.booking_status.in_progress%></span>',
        'done' : '<span class="btn btn-minw btn-rounded btn-noborder btn-primary push-5" style="font-size:100%"><%= t.booking_status.done%></span>',
        'cancelled' : '<span class="btn btn-minw btn-rounded btn-noborder btn-danger push-5" style="font-size:100%"><%= t.booking_status.cancelled%></span>'
    }

    this.paymentStatusDescriptionText = {
        'none' : '<span class="btn btn-minw btn-rounded btn-noborder btn-warning push-5" style="font-size:100%"><%= t.booking_payment_status.none%></span>',
        'deposit' : '<span class="btn btn-minw btn-rounded btn-noborder btn-primary push-5" style="font-size:100%"><%= t.booking_payment_status.deposit%></span>',
        'total' : '<span class="btn btn-minw btn-rounded btn-noborder btn-success push-5" style="font-size:100%"><%= t.booking_payment_status.total%></span>',
        'refunded': '<span class="btn btn-minw btn-rounded btn-noborder btn-danger push-5" style="font-size:100%"><%= t.booking_payment_status.refunded%></span>'
    }

    this.chargeStatusDescription = {
       'pending': '<%= t.charge_status.pending %>',
       'processing': '<%= t.charge_status.processing %>',
       'done': '<%= t.charge_status.done %>',
       'denied': '<%= t.charge_status.denied %>',
       'refunded': '<%= t.charge_status.refunded%>'
    };

    this.paymentMethodDescription = {
       'cash':'<%= t.booking_payment_method.cash%>',
       'bank_transfer':'<%= t.booking_payment_method.bank_transfer%>',
       'credit_card':'<%= t.booking_payment_method.credit_card%>',
       'redsys256':'<%= t.booking_payment_method.redsys256%>',
       'santander':'<%= t.booking_payment_method.santander%>',
       'pi4b':'<%= t.booking_payment_method.pi4b%>',
       'cecabank':'<%= t.booking_payment_method.cecabank%>',
       'paypal_standard':'<%= t.booking_payment_method.paypal_standard%>',                                      
    }

    this.nextExternalInvoiceNumber = function() {
        $.ajax({
            type: 'GET',
            url : '/api/bookings/next-external-invoice-number',
            contentType: 'application/json; charset=utf-8',
            dataType : 'json',
            success: function(data, textStatus, jqXHR) {
                $('#external_invoice_number').val(data);
            }
        });
    }

    this.entityKey = function(entity) {
      return entity.id;
    }    
  	
    this.onRenderEntities = function(entities) {
      $('.elements-search').show(); 
      $('.new-entity-button').remove();
    }

    this.onProcessSearch = function() {
      <% if params[:search] %>
      $('input[name=search]').val('<%=params[:search]%>');
      <% end %>
    }

    this.onEdit = function(entity) {

      this.configForm(entity);
      this.configDates(entity);

      // Validation
      this.configValidations();

      var self = this;

      // == Customer

      // Select customer
      $('#select_customer_btn').bind('click', function(){

        self.selectCustomer(entity);

      });

      // Create customer
      $('#create_customer_btn').bind('click', function(){

        if (confirm('¿Está seguro que desea crear el cliente con los datos de la reserva?')) {
           var url = '/api/booking/'+entity.id+'/customer';
           YSDGui.lockBackground('#bbb');
           var unlock = false;   
           $.ajax({
               type: 'POST',
               url : url,
               success: function(data, textStatus, jqXHR) {
                 unlock = true;
                 YSDGui.unLockBackground();                    
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Cliente creado con éxito');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error creando cliente');
               },
              complete: function(jqXHT, textStatus) {
                if (!unlock) {
                    YSDGui.unLockBackground();
                }
              }
           });          
        }

      });

      // Update customer from reservation
      $('#update_customer_btn').bind('click', function(){

        if (confirm('¿Está seguro que desea actualizar el cliente con los datos de la reserva?')) {
           var url = '/api/booking/'+entity.id+'/sync-customer';
           YSDGui.lockBackground('#bbb');
           var unlock = false;   
           $.ajax({
               type: 'PUT',
               url : url,
               success: function(data, textStatus, jqXHR) {
                 unlock = true;
                 YSDGui.unLockBackground();                
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Cliente actualizado con éxito');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando cliente');
               },
              complete: function(jqXHT, textStatus) {
                if (!unlock) {
                    YSDGui.unLockBackground();
                }
              }
           });          
        }

      });

      // Update reservation from customer
      $('#sync_customer_btn').bind('click', function(){

        if (confirm('¿Está seguro que desea actualizar los datos de la reserva con los datos del cliente?')) {
           var url = '/api/booking/'+entity.id+'/customer';
           YSDGui.lockBackground('#bbb');
           var unlock = false;              
           $.ajax({
               type: 'PUT',
               url : url,
               success: function(data, textStatus, jqXHR) {
                 unlock = true;
                 YSDGui.unLockBackground();                    
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Reserva actualizada con éxito');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando reserva');
               },
              complete: function(jqXHT, textStatus) {
                if (!unlock) {
                    YSDGui.unLockBackground();
                }
              }
           });          
        }

      });

      <% if booking_item_family.driver %>
        $('#main_driver_button').bind('click', function(){
          self.prepareFormMainDriver(entity);
        });
        <% if booking_item_family.driver_license %>
          $('#additional_driver_button').bind('click', function(){
            self.prepareFormAdditionalDriver(entity);
          });
        <% end %>
      <% end %>

      // == Booking line

      // New booking line
      $('#new_booking_line_button').bind('click', function() {
        self.prepareFormNewBookingLine(entity);
      });

      $('.booking-line-item-id').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');
        var priceValue = $(this).attr('data-value-price');
        var quantity = parseInt($(this).attr('data-value-quantity'));
        if (!isNaN(quantity)){
            quantity = 1;
        }
        self.prepareFormEditBookingLineItemId(id, value, priceValue, quantity);
      });

      $('.booking-line-quantity').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');
        self.prepareFormEditBookingLineQuantity(id, value);
      });

      $('.booking-line-unit-cost').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');        
        self.prepareFormEditBookingLineItemUnitCost(id, value);
      });

      $('.booking-line-deposit').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');        
        self.prepareFormEditBookingLineItemDeposit(id, value);
      });  

      $('.booking-line-category-supplements').bind('click', function(){
        var id = $(this).attr('data-id');
        var cost1 = $(this).attr('data-value-cost-1');
        var cost2 = $(this).attr('data-value-cost-2');
        var cost3 = $(this).attr('data-value-cost-3');        
        self.prepareFormEditBookingLineCategorySupplements(id, cost1, cost2, cost3);
      });

      // == Booking extra

      // New extra
      $('#new_booking_extra_button').bind('click', function() {
        self.prepareFormNewBookingExtra(entity);
      });

      // Modify extra quantity
      $('.booking-extra-quantity').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');
        self.prepareFormEditBookingExtraQuantity(id, value);
      });

      // Modify extra item cost
      $('.booking-extra-item-cost').bind('click', function() {
        var id = $(this).attr('data-id');
        var value = $(this).attr('data-value');        
        self.prepareFormEditBookingExtraItemCost(id, value);
      });

      // Remove booking extra
      $('.remove-booking-extra-id').bind('click', function() {
        var bookingExtraId = $(this).attr('data-id');
        $("<div title='" + '<%=t.booking_management.form.extra_removed.confirm_delete_title%>' + "'>" +
                           '<%=t.booking_management.form.extra_removed.confirm_delete_message%>' + "</div>").dialog( 
          { height: 250, modal: true,        
            buttons: {
                Ok: function() {
                      response = true;
                      $(this).dialog( "close" );
                },
                Cancel: function() {
                      response = false;  
                      $( this ).dialog( "close" );
                }
          },
          close : function(event, ui) {                   
            if (response) {
              $.ajax({
                type: 'DELETE',
                url : '/api/booking/booking-extra?id='+bookingExtraId,
                success: function(data, textStatus, jqXHR) {
                  bookingManager.model.synchronizeCurrentEntity(data);
                  bookingManager.model.change_state('entity_updated_successfully');
                  alert('<%=t.booking_management.form.extra_removed.done%>');
                },
                error: function(data, textStatus, jqXHR) {
                  alert('<%=t.booking_management.form.extra_removed.error%>');
                }
              }); 
            }
          }
        }); 
      });

      // == Resource 

      this.configResourcesAutoEdition();
      $('.booking_item_reference_detail').bind('click', function() {
        var form = $(this)[0].form;
        var lineIdx = $(form).attr('data-lineindex');
        var resourceIdx = $(form).attr('data-resourceindex');
        self.prepareFormEditBookingLineResource(lineIdx, resourceIdx);
      });

      // == Charges

      // New charge
      $('#new_charge').bind('click', function(){
        self.prepareFormNewCharge(entity);       
      });

      // Remove charge
      $('.remove-booking-charges').bind('click', function() {
        var bookingId = $(this).attr('data-booking-id');
        var chargeId = $(this).attr('data-charge-id');
        $("<div title='" + '<%=t.booking_management.form.charge_removed.confirm_delete_title%>' + "'>" +
                           '<%=t.booking_management.form.charge_removed.confirm_delete_message%>' + "</div>").dialog( 
          { height: 250, modal: true,        
            buttons: {
                Ok: function() {
                      response = true;
                      $(this).dialog( "close" );
                },
                Cancel: function() {
                      response = false;  
                      $( this ).dialog( "close" );
                }
          },
          close : function(event, ui) {                   
            if (response) {
              $.ajax({
                type: 'DELETE',
                url : '/api/booking/booking-charge?booking_id='+bookingId+'&charge_id='+chargeId,
                success: function(data, textStatus, jqXHR) {
                  bookingManager.model.synchronizeCurrentEntity(data);
                  bookingManager.model.change_state('entity_updated_successfully');
                  alert('<%=t.booking_management.form.charge_removed.done%>');
                },
                error: function(data, textStatus, jqXHR) {
                  alert('<%=t.booking_management.form.charge_removed.error%>');
                }
              }); 
            }
          }
        }); 
      });

      // == Supplements

      $('#booking_supplements_button').bind('click', function() {
        self.prepareFormBookingSupplements(entity);
      });

      // == Deposit

      $('#booking_deposit_button').bind('click', function() {
         self.prepareFormBookingDeposit(entity);
      });

      // == Invoicing simple

      $('#next_external_invoice_number').bind('click', function(){
          self.nextExternalInvoiceNumber();
      })

      // == Newsfeed

      $.ajax({url: '/admin/newsfeed/booking/'+ entity.id, dataType: 'text'}).done(function(html) {
            var dom = $('<html />').prop('innerHTML', html);
            $('#newsfeed_container').html(dom.find('body #page_wrapper'));
            $('head').append(dom.find('script:not([src])'));
      });

      // == Sales channel 

      $('select[name=sales_channel_code]').bind('change', function(){
            if (confirm('<%=t.booking_management.form.update_sales_channel_confirm%>')) {
              bookingManager.model.update(null, null, this);
            }
            else {
               $(this).val($.data(this, 'current'));
               return false;
            }
      });

      // == Rental location code

      <% if multiple_rental_locations %>
      var dataSourceRentalLocation = new RemoteDataSource('/api/booking-rental-locations?all=yes',{'id':'code','description':'name'});
      var valueRentalLocation = entity.rental_location_code;
      var selectorRentalLocation = new SelectSelector('rental_location',
            dataSourceRentalLocation, valueRentalLocation, true );
      $('select[name=rental_location_code]').bind('change', function(){
            if (confirm('<%=t.booking_management.form.update_rental_location_code_confirm%>')) {
              bookingManager.model.update(null, null, this);
            }
            else {
               $(this).val($.data(this, 'current'));
               return false;
            }
      });
      <% end %>

      // == Invoicing : embed

      <% if @addon_invoicing %>
      $.ajax({url: '/admin/invoices/customer-invoices/list?reference_source=booking&reference='+entity.id, dataType: 'text'}).done(function(html) {
            var dom = $('<html />').prop('innerHTML', html);
            $('#invoicing_container').html(dom.find('body #page_wrapper'));
            $('head').append(dom.find('script:not([src])'));
            $('#new_invoice_btn').bind('click', function(){
              self.prepareFormNewInvoice(entity);
            });
      });      
      <% end %>

    }

    this.adaptFormData = function(data) {

        if (data.customer_language == '') {
            data.customer_language = null;
        }

        if (data.sales_channel_code == '') {
            data.sales_channel_code = null;
        }

        return data;

    }    

    // =============================== [ COMPLEMENTARY ] =================================

    this.statusClass = function(entity) {
      var className = null;
      switch (entity.status) {
        case 'pending_confirmation' :
          className = 'pending-status';
          break;
        case 'confirmed':
          className = 'confirmed-status';
          break;
        case 'in_progress':
          className = 'doing-status';
          break;
        case 'done':
          className = 'done-status';
          break;
        case 'cancelled':
          className = 'error-status';
          break;          
      }
      return className;
    }

    this.paymentStatusClass = function(entity) {
      var className = null;
      switch (entity.payment_status) {
        case 'none' :
          className = 'pending-status';
          break;
        case 'deposit':
          className = 'doing-status';
          break;
        case 'total':
          className = 'done-status';
          break;
        case 'refunded':
          className = 'error-status';
          break;          
      }
      return className; 
    }

    this.chargeStatusClass = function(entity) {
      var className = null;
      switch (entity.status) {
        case 'pending' :
          className = 'pending-status';
          break;
        case 'processing':
          className = 'doing-status';
          break; 
        case 'done':
          className = 'done-status';
          break;
        case 'denied':
          className = 'error-status';
          break;
        case 'refunded':
          className = 'error-status';
          break;          
      }
      return className;
    }    

    this.configForm = function(entity) {

      $('.delete-entity-button').hide();

    }

    this.configDates = function(entity) {

        $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );

        $('#external_invoice_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.external_invoice_date != null) {
            $('#external_invoice_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.external_invoice_date, 'dd/MM/yyyy')));
        }
    }

    this.configValidations = function() {

        this.configCustomerValidation();
        this.configRealPickupReturnValidation();

    }

    this.configResourcesAutoEdition = function() {

        var self = this;

        $('.resource_user_name').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_surname').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_document_id').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_phone').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_email').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.customer_height').bind('change', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.customer_weight').bind('change', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_2_name').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_2_surname').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_2_document_id').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_2_phone').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.resource_user_2_email').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.customer_2_height').bind('change', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.customer_2_weight').bind('change', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.km_miles_on_pickup').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.km_miles_on_return').bind('blur', function() {
            self.updateLineResource($(this)[0]);
        });
        $('.booking_item_reference').bind('change', function() {
            self.updateLineResource($(this)[0]);
        });
    }

    this.updateLineResource = function(control) {

       var form = $(control.form)
       var formdata = form.formParams(true);
       var lineIdx = form.attr('data-lineindex');
       var resourceIdx = form.attr('data-resourceindex');
       var booking = this.manager.model.currentEntity();
       var json_request = JSON.stringify(formdata);

       $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking-line-resource',
               success: function(data, textStatus, jqXHR) {
                 for (attribute in formdata) {
                   booking.booking_lines[lineIdx].booking_line_resources[resourceIdx][attribute] = formdata[attribute];
                 }
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error updating resource');
               }
           });

    }

    // ------------ Configure customer validation ------------------

    this.configCustomerValidation = function() {

        $('form[name=customer]').validate({

            submitHandler: function(form)
            {
                $('#customer_error_summary').html('');
                $('#customer_error_summary').hide();
                return false;
            },

            invalidHandler : function (form, validator) {
                $('#customer_error_summary').html('<%=t.booking_management.form.validations.customer_errors_summary%>');
                $('#customer_error_summary').show();
            },

            rules : {
                'customer_name': {
                    required: true
                },
                'customer_surname': {
                    required: true
                }
            },

            messages : {
                'customer_name': {
                    required: '<%=t.booking_management.form.validations.customer_name_required%>'
                },
                'customer_surname': {
                    required: '<%=t.booking_management.form.validations.customer_surname_required%>'
                }
            },

            errorPlacement : function(error, element) {

                if (element.attr('name') === 'customer_name' || element.attr('name') === 'customer_surname')  {
                    error.insertAfter('#customer_surname');
                }

                if (element.attr('name') === 'customer_phone') {
                    error.insertAfter('#customer_mobile_phone');
                }

                if (element.attr('name') === 'customer_email') {
                    error.insertAfter('#customer_email');
                }

            }

        });

    }

    this.configRealPickupReturnValidation = function() {

        $('form[name=real_pickup_return_form]').validate({

            submitHandler: function(form)
            {
                return false;
            },

            rules : {
                'pickup_time': {
                    time24: true
                },
                'return_time': {
                    time24: true
                }
            },

            messages : {
                'pickup_time': {
                    time24: '<%=t.validations.time_format_invalid%>'
                },
                'return_time': {
                    time24: '<%=t.validations.time_format_invalid%>'
                }
            }

        });

    }

    /* =================== PREPARE FORMS ========================= */

    this.prepareFormBookingSupplements = function(entity) { /* Show the form to edit deposit */

      var html = tmpl('edit_booking_supplements_script', {entity: entity});

      $('#booking_management_modal_container .modal-title').html('Modificar suplementos');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $('#update_booking_supplements_button').unbind('click');
      $('#update_booking_supplements_button').bind('click', function(){

        var formdata = $('form[name="edit_booking_supplements"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'POST',
               data : json_request,
               url : '/api/booking/booking-supplements',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Suplementos actualizados');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando suplementos: ' + data.responseText);
               }
           });

      });

    }    

    this.prepareFormBookingDeposit = function(entity) { /* Show the form to edit deposit */

        var html = tmpl('edit_booking_deposits_script', {entity: entity});

        $('#booking_management_modal_container .modal-title').html('Modificar fianza');
        $('#booking_management_modal_container .modal-body').html(html);
        $('#booking_management_modal_container').modal('show');

        $('#update_booking_deposit_button').unbind('click');
        $('#update_booking_deposit_button').bind('click', function(){

            var formdata = $('form[name="edit_booking_deposits"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'POST',
                data : json_request,
                url : '/api/booking/booking-deposits',
                success: function(data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Fianza actualizada');
                    $('#booking_management_modal_container').modal('hide');
                    //YSDGui.hideElement(document.getElementById('dialogs_container'));
                },
                error: function(data, textStatus, jqXHR) {
                    alert('Error actualizando fianza: ' + data.responseText);
                }
            });

        });

    }

    this.prepareFormMainDriver = function(entity) { 

        var html = tmpl('edit_driver_script', {entity: entity});
      
        $('#booking_management_modal_lg_container .modal-title').html('Editar datos');
        $('#booking_management_modal_lg_container .modal-body').html(html);
        $('#booking_management_modal_lg_container').modal('show');    

        this.configDriverDates(entity);
        this.configDriverValidation();

        $('form[name=driver] .update-entity-button').bind('click', function(event){
            var formdata = $('form[name="driver"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'PUT',
                data : json_request,
                url : '/api/booking',
                success: function(data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Datos actualizados con éxito');
                    $('#booking_management_modal_lg_container').modal('hide');
                },
                error: function(data, textStatus, jqXHR) {
                    alert('Error actualizando datos');
                }
            });
        });
    }

    this.prepareFormAdditionalDriver = function(entity) { 

        var html = tmpl('edit_additional_driver_script', {entity: entity});
      
        $('#booking_management_modal_lg_container .modal-title').html('Editar datos conductores adicionales');
        $('#booking_management_modal_lg_container .modal-body').html(html);
        $('#booking_management_modal_lg_container').modal('show');    
      
        this.configAdditionalDriversDates(entity);
        this.configAdditionalDriverValidation();
      
        $('form[name=additional_drivers] .update-entity-button').bind('click', function(event){
            event.preventDefault();
            var formdata = $('form[name="additional_drivers"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'PUT',
                data : json_request,
                url : '/api/booking',
                success: function(data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Datos actualizados con éxito');
                    $('#booking_management_modal_lg_container').modal('hide');
                },
                error: function(data, textStatus, jqXHR) {
                    alert('Error actualizando datos');
                }
            });
        });
    }

    this.prepareFormNewBookingLine = function(entity) { /* Show the form to create a new booking line */

        var html = tmpl('new_booking_line_script', {entity: entity});

        $('#booking_management_modal_container .modal-title').html('Añadir producto');
        $('#booking_management_modal_container .modal-body').html(html);
        $('#booking_management_modal_container').modal('show');

        var booking = this.manager.model.currentEntity();
        var url = '/api/booking/category-search';
        url += '?date_from='+booking.date_from.toString('yyyy-MM-dd');
        url += '&date_to='+booking.date_to.toString('yyyy-MM-dd');
        url += '&days='+booking.days;
        if (booking.sales_channel_code && booking.sales_channel_code != null && booking.sales_channel_code != '') {
            url += '&sales_channel=' + booking.sales_channel_code;
        }
        if (booking.promotion_code && booking.promotion_code != null && booking.promotion_code != '') {
            url += '&promotion_code=' + booking.promotion_code;
        }
        if (booking.rental_location_code && booking.rental_location_code != null && booking.rental_location_code != '') {
            url += '&rental_location_code=' + booking.rental_location_code;
        }

        var dataSourceModel = new RemoteDataSource(url,
                                                    {'id':'code','description':'full_description'});
        var valueModel = null;
        var selectorModel = new SelectSelector('new_booking_line_item_id',
            dataSourceModel, valueModel, true );

        $('#create_booking_line_button').unbind('click');
        $('#create_booking_line_button').bind('click', function(){

            var formdata = $('form[name="new_booking_line"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'POST',
                data : json_request,
                url : '/api/booking/booking-line',
                success: function(data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Nueva línea de producto añadida');
                    //YSDGui.hideElement(document.getElementById('dialogs_container'));
                    $('#booking_management_modal_container').modal('hide');
                },
                error: function(data, textStatus, jqXHR) {
                    alert('Error creando línea de reserva: ' + data.responseText);
                }
            });

        });

    }


    this.prepareFormEditBookingLineItemId = function(booking_line_id, item_id, price, quantity) {

      var html = tmpl('edit_booking_line_item_id_script', {booking_line_id: booking_line_id, 
         item_id: item_id, price: price});

      $('#booking_management_modal_container .modal-title').html('Modificar producto');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      var booking = this.manager.model.currentEntity();
      var url = '/api/booking/category-search';
      url += '?date_from='+booking.date_from.toString('yyyy-MM-dd');
      url += '&date_to='+booking.date_to.toString('yyyy-MM-dd');
      url += '&days='+booking.days;
      url += '&current_item_id='+item_id;
      if (booking.sales_channel_code && booking.sales_channel_code != null && booking.sales_channel_code != '') {
          url += '&sales_channel=' + booking.sales_channel_code;
      }
      if (booking.promotion_code && booking.promotion_code != null && booking.promotion_code != '') {
          url += '&promotion_code=' + booking.promotion_code;
      }
      if (booking.rental_location_code && booking.rental_location_code != null && booking.rental_location_code != '') {
          url += '&rental_location_code=' + booking.rental_location_code;
      }

      var dataSourceModel = new RemoteDataSource(url,
                                                 {'id':'code','description':'full_description'});
      var valueModel = item_id; 
      var selectorModel = new SelectSelector('edit_booking_line_item_id',
                                             dataSourceModel, valueModel, true );

      $('#edit_booking_line_item_id').unbind('change');
      $('#edit_booking_line_item_id').bind('change', function(){
          var value = $(this).val();
          var selectedItem = null;
          for (var idx=0;idx<dataSourceModel.data.length;idx++) {
              if (value == dataSourceModel.data[idx].code) {
                  selectedItem = dataSourceModel.data[idx];
                  break;
              }
          }
          if (selectedItem != null && selectedItem.code != item_id) {
              if (selectedItem.available < quantity) {
                  $('#edit_booking_line_item_id_warning').show();
              }
              else {
                  $('#edit_booking_line_item_id_warning').hide();
              }
          }
          else {
              $('#edit_booking_line_item_id_warning').hide();
          }
      });

      $('#edit_booking_line_item_id_button').unbind('click');
      $('#edit_booking_line_item_id_button').bind('click', function(){

        if (confirm('¿Está seguro que desea realizar el cambio?')) {
            var formdata = $('form[name="update_booking_line_item_id"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'PUT',
                data: json_request,
                url: '/api/booking/booking-line/item-id',
                success: function (data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Producto actualizado');
                    $('#booking_management_modal_container').modal('hide');
                },
                error: function (data, textStatus, jqXHR) {
                    alert('Error actualizando producto: ' + data.responseText);
                }
            });
        }

      });


    } 

    this.prepareFormEditBookingLineQuantity = function(booking_line_id, quantity) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_line_quantity_script', {booking_line_id: booking_line_id, quantity: quantity});

      $('#booking_management_modal_container .modal-title').html('Modificar cantidad');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');
      
      $('#edit_booking_line_quantity_button').unbind('click');
      $('#edit_booking_line_quantity_button').bind('click', function(){

        var formdata = $('form[name="update_booking_line_quantity"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-line/quantity',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Cantidad actualizada');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando cantidad: ' + data.responseText);
               }
           });

      });

    }


    this.prepareFormEditBookingLineItemUnitCost = function(booking_line_id, item_unit_cost) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_line_item_cost_script', {booking_line_id: booking_line_id, item_unit_cost: item_unit_cost});

      $('#booking_management_modal_container .modal-title').html('Modificar precio');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $('#edit_booking_item_cost_button').unbind('click');
      $('#edit_booking_item_cost_button').bind('click', function(){

        var formdata = $('form[name="update_booking_line_item_cost"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-line/item-cost',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Coste actualizado');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando coste: ' + data.responseText);
               }
           });

      });

    }

    this.prepareFormEditBookingLineItemDeposit = function(booking_line_id, item_deposit) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_line_deposit_cost_script', {booking_line_id: booking_line_id, item_deposit: item_deposit});

      $('#booking_management_modal_container .modal-title').html('Modificar fianza');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $('#edit_booking_item_deposit_button').unbind('click');
      $('#edit_booking_item_deposit_button').bind('click', function(){

        var formdata = $('form[name="update_booking_line_deposit_cost"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-line/deposit',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Fianza actualizada');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando fianza: ' + data.responseText);
               }
           });

      });

    }

    this.prepareFormEditBookingLineCategorySupplements = function(booking_line_id, category_supplement_1_unit_cost, category_supplement_2_unit_cost, category_supplement_3_unit_cost) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_line_supplements_script', {booking_line_id: booking_line_id,
                                                              category_supplement_1_unit_cost: category_supplement_1_unit_cost,
                                                              category_supplement_2_unit_cost: category_supplement_2_unit_cost,
                                                              category_supplement_3_unit_cost: category_supplement_3_unit_cost});

      $('#booking_management_modal_container .modal-title').html('Modificar suplementos');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $('#update_booking_item_supplements_button').unbind('click');
      $('#update_booking_item_supplements_button').bind('click', function(){

        var formdata = $('form[name="edit_booking_line_supplements"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-line/category-supplements',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Suplementos actualizados');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando suplementos: ' + data.responseText);
               }
           });

      });

    }    

    this.prepareFormEditBookingExtraQuantity = function(booking_extra_id, quantity) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_extra_quantity_script', {booking_extra_id: booking_extra_id, quantity: quantity});

      $('#booking_management_modal_container .modal-title').html('Modificar cantidad extra');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $('#edit_booking_extra_quantity_button').unbind('click');
      $('#edit_booking_extra_quantity_button').bind('click', function(){

        var formdata = $('form[name="update_booking_extra_quantity"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-extra/quantity',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Cantidad de extra actualizada');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando cantidad del extra: ' + data.responseText);
               }
           });

      });

    }

    this.prepareFormNewBookingExtra = function(entity) { /* Show the form to create a new booking line */

        var html = tmpl('new_booking_extra_script', {entity: entity});

        $('#booking_management_modal_container .modal-title').html('Añadir extra');
        $('#booking_management_modal_container .modal-body').html(html);
        $('#booking_management_modal_container').modal('show');

        var dataSourceModel = new RemoteDataSource('/api/booking-extras?all=yes',{'id':'code','description':'name'});
        var valueModel = null;
        var selectorModel = new SelectSelector('new_booking_extra_extra_id',
            dataSourceModel, valueModel, true);

        $('#create_booking_extra_button').unbind('click');
        $('#create_booking_extra_button').bind('click', function(){

            var formdata = $('form[name="new_booking_extra"]').formParams(true);
            var json_request = JSON.stringify(formdata);
            $.ajax({
                type: 'POST',
                data : json_request,
                url : '/api/booking/booking-extra',
                success: function(data, textStatus, jqXHR) {
                    bookingManager.model.synchronizeCurrentEntity(data);
                    bookingManager.model.change_state('entity_updated_successfully');
                    alert('Nuevo extra añadido');
                    $('#booking_management_modal_container').modal('hide');
                    //YSDGui.hideElement(document.getElementById('dialogs_container'));
                },
                error: function(data, textStatus, jqXHR) {
                    alert('Error creando extra: ' + data.responseText);
                }
            });

        });

    }

    this.prepareFormEditBookingExtraItemCost = function(booking_extra_id, extra_unit_cost) { /* Show the form to create a new booking line */

      var html = tmpl('edit_booking_extra_item_cost_script', {booking_extra_id: booking_extra_id, extra_unit_cost: extra_unit_cost});
      $('#booking_management_modal_container .modal-title').html('Modificar precio extra');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');
      
      $('#edit_booking_extra_cost_button').unbind('click');
      $('#edit_booking_extra_cost_button').bind('click', function(){

        var formdata = $('form[name="update_booking_extra_item_cost"]').formParams(true);
        var json_request = JSON.stringify(formdata);
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking/booking-extra/extra-cost',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('Coste de extra actualizado');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error actualizando coste del extra: ' + data.responseText);
               }
           });

      });

    }

    this.prepareFormEditBookingLineResource = function(lineIdx, resourceIdx) {

      var booking = this.manager.model.currentEntity();
      var bookingLineResource = booking.booking_lines[lineIdx].booking_line_resources[resourceIdx];

      var html = tmpl('booking_line_resource_detail_script', {entity: bookingLineResource});

      $('#booking_management_modal_container .modal-title').html('Modificar recurso');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');
      
      $('#update_booking_line_resource_button').unbind('click');
      $('#update_booking_line_resource_button').bind('click', function(){
        var formdata = $('form[name="update_booking_line_resource"]').formParams(true);
        var json_request = JSON.stringify(formdata);       
        $.ajax({
               type: 'PUT',
               data : json_request,
               url : '/api/booking-line-resource',
               success: function(data, textStatus, jqXHR) {
                 for (attribute in formdata) {
                   booking.booking_lines[lineIdx].booking_line_resources[resourceIdx][attribute] = formdata[attribute];
                 }
                 alert('Datos actualizados');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error updating resource');
               }
           });

      });

    }

    this.prepareFormNewCharge = function(entity) { /* Show the form to create new charge */

        var html = tmpl('new_charge_script', {entity: entity});

        $('#booking_management_modal_container .modal-title').html('Nuevo cobro');
        $('#booking_management_modal_container .modal-body').html(html);
        $('#booking_management_modal_container').modal('show');

        $('#new_charge_button').unbind('click');
        $('#new_charge_date').datetimepicker(
            {controlType: 'select', showTimezone: false, useLocalTimezone: true, 
             numberOfMonths:1, dateFormat: 'dd/mm/yy'},
            '<%= session[:locale] %>');
        $('#new_charge_date').datetimepicker('setDate', new Date());
        $('#new_charge_amount').autoNumeric('init',{aSep:''});
        $('#new_charge_button').bind('click', function(){
           var formdata = $('form[name="charge"]').formParams(true);
           var json_request = JSON.stringify(formdata);
           $.ajax({
               type: 'POST',
               data : json_request,
               url : '/api/booking/charge',
               success: function(data, textStatus, jqXHR) {
                 bookingManager.model.synchronizeCurrentEntity(data);
                 bookingManager.model.change_state('entity_updated_successfully');
                 alert('<%=t.booking_management.charge_form.done%>');
                 $('#booking_management_modal_container').modal('hide');
               },
               error: function(data, textStatus, jqXHR) {
                 alert('Error updating resource');
               }
           });
        });       

    }

    this.prepareFormNewInvoice = function(entity) { /* Show the form to create new invoice */

      var html = tmpl('new_invoice_script', {entity: entity});

      $('#booking_management_modal_container .modal-title').html('Crear factura');
      $('#booking_management_modal_container .modal-body').html(html);
      $('#booking_management_modal_container').modal('show');

      $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );
      var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];
      $('#new_invoice_date').datepicker({numberOfMonths:1},
                                        locale);
      $('#new_invoice_date').datepicker('setDate', new Date());
      $('#new_invoice_price_without_taxes').autoNumeric('init',{aSep:''});

      $('#new_invoice_manual_concept').bind('change', function(){
        if ($('#new_invoice_manual_concept').is(':checked')) {
          $('form[name=new_invoice_form] select[name=concept]').hide();
          $('form[name=new_invoice_form] input[name=concept]').show();
        }
        else {
          $('form[name=new_invoice_form] select[name=concept]').hide();
          $('form[name=new_invoice_form] input[name=concept]').show(); 
        }
      }); 

      $('form[name=new_invoice_form]').data('validator', null);
      $('form[name=new_invoice_form]').unbind('validate');
      $('form[name=new_invoice_form]').validate({

            submitHandler: function(form)
            {
                $('#new_invoice_error_summary').html('');
                $('#new_invoice_error_summary').hide();
                return false;
            },

            invalidHandler : function (form, validator) {
                $('#new_invoice_error_summary').html('<%=t.booking_management.form.validations.customer_errors_summary%>');
                $('#new_invoice_error_summary').show();
            },

            rules : {
               'date': {
                    required: true
                },
                'concept': {
                    required: true,
                    minlength: 1
                },
                'price_without_taxes': {
                    required: true,
                    min: 0.01,
                }
            },

            messages : {
                'date': {
                    required: 'Fecha factura obligatoria'
                },
                'concept': {
                    required: 'Concepto factura obligatorio',
                    minlength: 'Concepto factura obligatorio'
                },
                'price_without_taxes': {
                    required: 'Concepto línea factura obligatorio',
                    min: 'El importe debe ser mayor que 0'
                }
            }

        });

      $('#create_invoice_button').unbind('click');
      $('#create_invoice_button').bind('click', function(){

        if ($('form[name=new_invoice_form]').valid()) {
          var formdata = $('form[name="new_invoice_form"]').formParams(true);
          if (!($('#new_invoice_manual_concept').is(':checked'))) {
            formdata.concept = $('form[name=new_invoice_form] select[name=concept]').val();
          }          
          if ($('#new_invoice_taxes_included').is(':checked')) {
            formdata.taxes_included = true;
          }
          else {
            formdata.taxes_included = false;
          }
          var json_request = JSON.stringify(formdata);
          $.ajax({
                 type: 'POST',
                 data : json_request,
                 url : '/api/booking/'+entity.id+'/invoice',
                 success: function(data, textStatus, jqXHR) {
                   alert('Factura creada');
                   $.ajax({url: '/admin/invoices/customer-invoices/list?reference_source=booking&reference='+entity.id, dataType: 'text'}).done(function(html) {
                      var dom = $('<html />').prop('innerHTML', html);
                      $('#invoicing_container').html(dom.find('body #page_wrapper'));
                      $('head').append(dom.find('script:not([src])'));
                                });                       
                   $('#booking_management_modal_container').modal('hide');
                 },
                 error: function(data, textStatus, jqXHR) {
                   alert('Error creando factura');
                 }
             });
        }

      });

    }     

    /* ==================== CUSTOMER =================== */

    this.selectCustomer = function(entity) {

      selectCustomerModel.removeListener(this);
      selectCustomerModel.addListener(this);
      selectCustomerView.show();

    }

    /* ==================== DRIVER ===================== */

    /* ------- Driver/Contact ------ */

    this.configDriverDates = function(entity) {

        $('#driver_date_of_birth').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.driver_date_of_birth != null) {
            $('#driver_date_of_birth').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.driver_date_of_birth, 'dd/MM/yyyy')));
        }

        $('#driver_document_id_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.driver_document_id_date != null) {
            $('#driver_document_id_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.driver_document_id_date, 'dd/MM/yyyy')));
        }

        $('#driver_document_id_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.driver_document_id_expiration_date != null) {
            $('#driver_document_id_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.driver_document_id_expiration_date, 'dd/MM/yyyy')));
        }

        $('#driver_driving_license_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.driver_driving_license_date != null) {
            $('#driver_driving_license_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.driver_driving_license_date, 'dd/MM/yyyy')));
        }

        $('#driver_driving_license_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.driver_driving_license_expiration_date != null) {
            $('#driver_driving_license_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.driver_driving_license_expiration_date, 'dd/MM/yyyy')));
        }

    }

    this.configDriverValidation = function() {

        $('form[name=driver]').validate({

            submitHandler: function(form)
            {
                $('#driver_error_summary').html('');
                $('#driver_error_summary').hide();
                return false;
            },

            invalidHandler : function (form, validator) {
                $('#driver_error_summary').html('<%=t.booking_management.form.validations.driver_errors_summary%>');
                $('#driver_error_summary').show();
            },

            rules : {
                'driver_date_of_birth': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date().add(-18).years(),
                },
                'driver_driving_license_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date()
                },
                'driver_driving_license_expiration_date': {
                    validDate: true,
                    minDate: new Date()
                },
                'driver_document_id_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date(),
                },
                'driver_document_id_expiration_date': {
                    validDate: true,
                    minDate: new Date()
                }
            },

            messages : {
                'driver_date_of_birth': {
                    validDate: '<%=t.booking_management.form.validations.driver_date_of_birth_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.driver_date_of_birth_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.driver_date_of_birth_max((d=Date.today;Date.new(d.year-18,d.month,d.day)).strftime('%d-%m-%Y'))%>'
                },
                'driver_driving_license_date': {
                    validDate: '<%=t.booking_management.form.validations.driver_driving_license_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.driver_driving_license_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.driver_driving_license_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'driver_driving_license_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.driver_driving_license_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.driver_driving_license_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'driver_document_id_date': {
                    validDate: '<%=t.booking_management.form.validations.driver_document_id_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.driver_document_id_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.driver_document_id_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'driver_document_id_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.driver_document_id_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.driver_document_id_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                }

            },

            errorPlacement : function(error, element) {

                if (element.attr('name') === 'driver_date_of_birth')  {
                    error.insertAfter('#driver_date_of_birth');
                }

                if (element.attr('name') === 'driver_driving_license_date')  {
                    error.insertAfter('#driver_driving_license_date');
                }

                if (element.attr('name') === 'driver_driving_license_expiration_date')  {
                    error.insertAfter('#driver_driving_license_expiration_date');
                }

                if (element.attr('name') === 'driver_document_id_date')  {
                    error.insertAfter('#driver_document_id_date');
                }

                if (element.attr('name') === 'driver_document_id_expiration_date')  {
                    error.insertAfter('#driver_document_id_expiration_date');
                }

            }

        });

    }

    /* --------- Additional driver ------------ */
        
    this.configAdditionalDriversDates = function(entity) {
    
        $('#additional_driver_1_date_of_birth').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_1_date_of_birth != null) {
            $('#additional_driver_1_date_of_birth').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_1_date_of_birth, 'dd/MM/yyyy')));
        }

        $('#additional_driver_1_document_id_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_1_document_id_date != null) {
            $('#additional_driver_1_document_id_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_1_document_id_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_1_document_id_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_1_document_id_expiration_date != null) {
            $('#additional_driver_1_document_id_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_1_document_id_expiration_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_1_driving_license_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_1_driving_license_date != null) {
            $('#additional_driver_1_driving_license_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_1_driving_license_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_1_driving_license_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_1_driving_license_expiration_date != null) {
            $('#additional_driver_1_driving_license_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_1_driving_license_expiration_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_2_date_of_birth').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_2_date_of_birth != null) {
            $('#additional_driver_2_date_of_birth').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_2_date_of_birth, 'dd/MM/yyyy')));
        }

        $('#additional_driver_2_document_id_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_2_document_id_date != null) {
            $('#additional_driver_2_document_id_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_2_document_id_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_2_document_id_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_2_document_id_expiration_date != null) {
            $('#additional_driver_2_document_id_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_2_document_id_expiration_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_2_driving_license_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', maxDate: new Date(), defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_2_driving_license_date != null) {
            $('#additional_driver_2_driving_license_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_2_driving_license_date, 'dd/MM/yyyy')));
        }

        $('#additional_driver_2_driving_license_expiration_date').datepicker({numberOfMonths:1, dateFormat: 'dd/mm/yy', defaultDate: ''}, "<%=session[:locale] || 'es'%>" );
        if (entity.additional_driver_2_driving_license_expiration_date != null) {
            $('#additional_driver_2_driving_license_expiration_date').datepicker("setDate", $.datepicker.parseDate("dd/mm/yy", bookingManager.view.formatDate(entity.additional_driver_2_driving_license_expiration_date, 'dd/MM/yyyy')));
        }

    }

    this.configAdditionalDriverValidation = function() {

        $('form[name=additional_drivers]').validate({

            submitHandler: function(form)
            {
                $('#additional_drivers_error_summary').html('');
                $('#additional_drivers_error_summary').hide();
                return false;
            },

            invalidHandler : function (form, validator) {
                $('#additional_drivers_error_summary').html('<%=t.booking_management.form.validations.driver_errors_summary%>');
                $('#additional_drivers_error_summary').show();
            },

            rules : {
                'additional_driver_1_date_of_birth': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date().add(-18).years()
                },
                'additional_driver_1_driving_license_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date()
                },
                'additional_driver_1_driving_license_expiration_date': {
                    validDate: true,
                    minDate: new Date()
               },
                'additional_driver_1_document_id_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date(),
                },
                'additional_driver_1_document_id_expiration_date': {
                    validDate: true,
                    minDate: new Date()
                },
                'additional_driver_2_date_of_birth': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date().add(-18).years()
                },
                'additional_driver_2_driving_license_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date()
                },
                'additional_driver_2_driving_license_expiration_date': {
                    validDate: true,
                    minDate: new Date()
                },
                'additional_driver_2_document_id_date': {
                    validDate: true,
                    minDate: new Date().add(-100).years(),
                    maxDate: new Date(),
                },
                'additional_driver_2_document_id_expiration_date': {
                    validDate: true,
                    minDate: new Date()
                }
            },

            messages : {
                'additional_driver_1_date_of_birth': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_1_date_of_birth_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_1_date_of_birth_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_1_date_of_birth_max((d=Date.today;Date.new(d.year-18,d.month,d.day)).strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_1_driving_license_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_1_driving_license_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_1_driving_license_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_1_driving_license_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_1_driving_license_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_1_driving_license_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_1_driving_license_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_1_document_id_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_1_document_id_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_1_document_id_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_1_document_id_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_1_document_id_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_1_document_id_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_1_document_id_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_2_date_of_birth': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_2_date_of_birth_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_2_date_of_birth_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_2_date_of_birth_max((d=Date.today;Date.new(d.year-18,d.month,d.day)).strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_2_driving_license_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_2_driving_license_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_2_driving_license_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_2_driving_license_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_2_driving_license_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_2_driving_license_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_2_driving_license_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_2_document_id_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_2_document_id_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_2_document_id_date_min((d=Date.today;Date.new(d.year-100,d.month,d.day)).strftime('%d-%m-%Y'))%>',
                    maxDate: '<%=t.booking_management.form.validations.additional_driver_2_document_id_date_max(Date.today.strftime('%d-%m-%Y'))%>'
                },
                'additional_driver_2_document_id_expiration_date': {
                    validDate: '<%=t.booking_management.form.validations.additional_driver_2_document_id_expiration_date_invalid_date%>',
                    minDate: '<%=t.booking_management.form.validations.additional_driver_2_document_id_expiration_date_min(Date.today.strftime('%d-%m-%Y'))%>'
                }
            },

            errorPlacement : function(error, element) {

                if (element.attr('name') === 'additional_driver_1_date_of_birth')  {
                    error.insertAfter('#additional_driver_1_date_of_birth');
                }

                if (element.attr('name') === 'additional_driver_1_driving_license_date')  {
                    error.insertAfter('#additional_driver_1_driving_license_date');
                }

                if (element.attr('name') === 'additional_driver_1_driving_license_expiration_date')  {
                    error.insertAfter('#additional_driver_1_driving_license_expiration_date');
                }

                if (element.attr('name') === 'additional_driver_1_document_id_date')  {
                    error.insertAfter('#additional_driver_1_document_id_date');
                }

                if (element.attr('name') === 'additional_driver_1_document_id_expiration_date')  {
                    error.insertAfter('#additional_driver_1_document_id_expiration_date');
                }

                if (element.attr('name') === 'additional_driver_2_date_of_birth')  {
                    error.insertAfter('#additional_driver_2_date_of_birth');
                }

                if (element.attr('name') === 'additional_driver_2_driving_license_date')  {
                    error.insertAfter('#additional_driver_2_driving_license_date');
                }

                if (element.attr('name') === 'additional_driver_2_driving_license_expiration_date')  {
                    error.insertAfter('#additional_driver_2_driving_license_expiration_date');
                }

                if (element.attr('name') === 'additional_driver_2_document_id_date')  {
                    error.insertAfter('#additional_driver_2_document_id_date');
                }

                if (element.attr('name') === 'additional_driver_2_document_id_expiration_date')  {
                    error.insertAfter('#additional_driver_2_document_id_expiration_date');
                }

            }

        });

    }    


  };
  
  var urls = { 
  	           query_url  : '/api/bookings',
  	           get_url : '/api/booking',
               update_url: '/api/booking'
             };
  
  var bookingHook = new BookingHook();
  var bookingManager = new EntityManagement(urls, 'bookings', <%=bookings_page_size%>, bookingHook, 
        {prefix: '/admin/booking', hold_form_after_action:true, lazy_loading: true});
 
 });
