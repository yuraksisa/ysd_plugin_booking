require(["jquery",'ysdtemplate', "YSDMemoryDataSource", "YSDSelectSelector", "jquery.ui", 'jquery.validate', 
           'jquery.placeholder', 'jquery.ui', 'jquery.ui.datepicker-es', 
           'jquery.ui.datepicker.validation',
           'jquery.tools', 'jquery.formparams', 'datejs'],
         function($, tmpl, MemoryDataSource, SelectSelector) {
    cyclicModel = {
       date: null,
       turn: null,
       dateLiteral: null,
       total: 0,
       capacity: <%=@activity.capacity%>,
       all_days_same_turns: <%=@activity.all_days_same_turns%>,
       season_prices: <%=@activity.season_prices?%>,
       morning_turns: '<%=@activity.morning_turns%>',
       afternoon_turns: '<%=@activity.afternoon_turns%>',
       night_turns: '<%=@activity.night_turns%>',
       sunday_morning_turns: '<%=@activity.sunday_morning_turns%>',
       sunday_afternoon_turns: '<%=@activity.sunday_afternoon_turns%>',
       sunday_night_turns: '<%=@activity.sunday_night_turns%>',
       monday_morning_turns: '<%=@activity.monday_morning_turns%>',
       monday_afternoon_turns: '<%=@activity.monday_afternoon_turns%>',
       monday_night_turns: '<%=@activity.monday_night_turns%>',
       tuesday_morning_turns: '<%=@activity.tuesday_morning_turns%>',
       tuesday_afternoon_turns: '<%=@activity.tuesday_afternoon_turns%>',
       tuesday_night_turns: '<%=@activity.tuesday_night_turns%>',
       wednesday_morning_turns: '<%=@activity.wednesday_morning_turns%>',
       wednesday_afternoon_turns: '<%=@activity.wednesday_afternoon_turns%>',
       wednesday_night_turns: '<%=@activity.wednesday_night_turns%>',
       thursday_morning_turns: '<%=@activity.thursday_morning_turns%>',
       thursday_afternoon_turns: '<%=@activity.thursday_afternoon_turns%>',
       thursday_night_turns: '<%=@activity.thursday_night_turns%>', 
       friday_morning_turns: '<%=@activity.friday_morning_turns%>',
       friday_afternoon_turns: '<%=@activity.friday_afternoon_turns%>',
       friday_night_turns: '<%=@activity.friday_night_turns%>',
       saturday_morning_turns: '<%=@activity.saturday_morning_turns%>',
       saturday_afternoon_turns: '<%=@activity.saturday_afternoon_turns%>',
       saturday_night_turns: '<%=@activity.saturday_night_turns%>',
       price_1_defined : <%=!@activity.price_definition_1.nil?%>,
       price_1_description: '<%=@activity.price_1_description%>',
       price_2_defined : <%=!@activity.price_definition_2.nil?%>,
       price_2_description: '<%=@activity.price_2_description%>',
       price_3_defined: <%=!@activity.price_definition_3.nil?%>,
       price_3_description: '<%=@activity.price_3_description%>',
       morningTurns: [],
       afternoonTurns: [],
       nightTurns: [],
       <% rates = @activity.rates(Date.today) %>
       prices_1 : {
         <% unless @activity.price_definition_1.nil? %>
            <% rates[1].each do |quantity, price| %>
              '<%=quantity%>':<%="%.2f" % price%>, 
            <% end %>
         <% end %>
       },
       prices_2 : {
         <% unless @activity.price_definition_2.nil? %>
            <% rates[2].each do |quantity, price| %>
              '<%=quantity%>':<%="%.2f" % price%>,  
            <% end %>
         <% end %>
       },
       prices_3 : {
         <% unless @activity.price_definition_3.nil? %>
            <% rates[3].each do |quantity, price| %>
              '<%=quantity%>':<%="%.2f" % price%>,
            <% end %>  
         <% end %>
       },
       buildTurns: function() {
           this.total = 0;
           this.date = $('#datepicker').datepicker("getDate").toString('yyyy-MM-dd');
           this.dateLiteral = $('#datepicker').datepicker("getDate").toString('dd MMMM, yyyy');
           var _morningTurns = '', _afternoonTurns = '', _nightTurns = '';
           if (this.all_days_same_turns) {
             _morningTurns = this.morning_turns;
             _afternoonTurns = this.afternoon_turns;
             _nightTurns = this.night_turns;
           }
           else {
             var dayOfWeek = Date.parse(this.date,'yyyy-MM-dd').getDay();
             switch (dayOfWeek) {
                case 0:
                  _morningTurns = this.sunday_morning_turns;
                  _afternoonTurns = this.sunday_afternoon_turns;
                  _nightTurns = this.sunday_night_turns;
                  break;
                case 1:
                  _morningTurns = this.monday_morning_turns;
                  _afternoonTurns = this.monday_afternoon_turns;
                  _nightTurns = this.monday_night_turns;                
                  break;
                case 2:
                  _morningTurns = this.tuesday_morning_turns;
                  _afternoonTurns = this.tuesday_afternoon_turns;
                  _nightTurns = this.tuesday_night_turns;                
                  break;
                case 3:
                  _morningTurns = this.wednesday_morning_turns;
                  _afternoonTurns = this.wednesday_afternoon_turns;
                  _nightTurns = this.wednesday_night_turns;                
                  break;
                case 4:
                  _morningTurns = this.thursday_morning_turns;
                  _afternoonTurns = this.thursday_afternoon_turns;
                  _nightTurns = this.thursday_night_turns;                
                  break;
                case 5:
                  _morningTurns = this.friday_morning_turns;
                  _afternoonTurns = this.friday_afternoon_turns;
                  _nightTurns = this.friday_night_turns;                
                  break;
                case 6:
                  _morningTurns = this.saturday_morning_turns;
                  _afternoonTurns = this.saturday_afternoon_turns;
                  _nightTurns = this.saturday_night_turns;                
                  break;
             }             
           }

          this.morningTurns = _morningTurns.split(',').filter(function(element){return element != '';});
          this.afternoonTurns = _afternoonTurns.split(',').filter(function(element){return element != '';});
          this.nightTurns = _nightTurns.split(',').filter(function(element){return element != '';});
          
          cyclicView.updatePrice();
          cyclicView.updateDate();
          cyclicView.updateTurns();
          cyclicView.loadCapacity();
       },
       calculatePrice: function() {
          this.total = 0;
          if (this.prices_1[$('#quantity_rate_1').val()]) {
            this.total += this.prices_1[$('#quantity_rate_1').val()];
          }
          if (this.prices_2[$('#quantity_rate_2').val()]) {
            this.total += this.prices_2[$('#quantity_rate_2').val()];
          }
          if (this.prices_3[$('#quantity_rate_3').val()]) {
            this.total += this.prices_1[$('#quantity_rate_3').val()];
          }          
          cyclicView.updatePrice();
       }                                  
    };

    cyclicController = {
        onDateChanged: function() {
            cyclicModel.buildTurns();
        },
        onQuantityChanged: function() {
            cyclicModel.calculatePrice();
        }
    };

    cyclicView = {
        init: function() {
            $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );
            $("#datepicker").datepicker({
              minDate: new Date(),
              beforeShowDay: function(date){
                // Make sure invalidates not available dates
                if (date.getDate() == 14) {
                    return [false];
                }
                return [true];
              }
            });
            $('#datepicker').bind('change', function() {
               cyclicController.onDateChanged();
            });  
            $('.quantity_rate').bind('change', function() {
               cyclicController.onQuantityChanged();
            });
            cyclicModel.buildTurns();
            this.loadCapacity();
        },

        updateDate: function() {
          $('#date_text').html(cyclicModel.dateLiteral);
          $('#date').val(cyclicModel.date);
        },

        updatePrice: function() {
           $('#total').html(cyclicModel.total.toFixed(2) + '€');
           if (cyclicModel.total > 0) {
             $('#total').show();
           }
           else {
             $('#total').hide();
           }
        },

        updateTurns: function() {

           var html = tmpl('script_turns_blocks',
             {morningTurns: cyclicModel.morningTurns,
              afternoonTurns: cyclicModel.afternoonTurns,
              nightTurns: cyclicModel.nightTurns});
           
           if (cyclicModel.morningTurns.length > 0 ||
               cyclicModel.afternoonTurns.length > 0 || 
               cyclicModel.nightTurns.length > 0) {
              $('#botonera').show();
           }
           else {
              $('#botonera').hide();
           }

           $('#turns').html(html);

        },

        loadCapacity: function() {
          
          if (cyclicModel.morningTurns.length > 0 ||
              cyclicModel.afternoonTurns.length > 0 || 
              cyclicModel.nightTurns.length > 0) {
            
            // Price 1
            if (cyclicModel.price_1_defined) {
              var capacities = [];
              capacities.push({id:0,
                               description: '0 X ' + cyclicModel.price_1_description});
              for (idx=1;idx <=cyclicModel.capacity; idx++) {
                capacities.push({id:idx,
                                 description:this.format(idx,cyclicModel.price_1_description,
                                                    cyclicModel.prices_1[idx])});
              }           
              var capacitiesDataSource = new MemoryDataSource(capacities);
              var capacitiesSelectSelector = new SelectSelector('quantity_rate_1', capacitiesDataSource);
              $('#quantity_rate_1').show();
            }
            else {
              $('#quantity_rate_1').hide();
            }
            // Price 2
            if (cyclicModel.price_2_defined) {
              var capacities = [];
              capacities.push({id:0,
                               description: '0 X ' + cyclicModel.price_2_description});              
              for (idx=1;idx <=cyclicModel.capacity; idx++) {
                capacities.push({id:idx,
                                 description:this.format(idx,cyclicModel.price_2_description,
                                                    cyclicModel.prices_2[idx])});
              }           
              var capacitiesDataSource = new MemoryDataSource(capacities);
              var capacitiesSelectSelector = new SelectSelector('quantity_rate_2', capacitiesDataSource);
              $('#quantity_rate_2').show();
            }
            else {
              $('#quantity_rate_2').hide();
            }
            // Price 3
            if (cyclicModel.price_3_defined) {
              var capacities = [];
              capacities.push({id:0,
                               description: '0 X ' + cyclicModel.price_3_description});              
              for (idx=1;idx <=cyclicModel.capacity; idx++) {
                capacities.push({id:idx,
                                 description:this.format(idx,cyclicModel.price_3_description,
                                                    cyclicModel.prices_3[idx])});
              }           
              var capacitiesDataSource = new MemoryDataSource(capacities);
              var capacitiesSelectSelector = new SelectSelector('quantity_rate_3', capacitiesDataSource);
              $('#quantity_rate_3').show();
            }
            else {
              $('#quantity_rate_3').hide();
            }

            $('#tickets').show();
          }
          else {
            $('#tickets').hide();
          }

        },

        format: function(quantity, priceDescription, price) {
           var extraSpaceIdx = (quantity < 10) ? ' ' : '';
           var extraSpacePrice = '';
           var max = 15 - price.toString().length;
           for (var idx=0; idx < max; idx++) {
             extraSpacePrice += ' ';
           }

           var value = quantity + extraSpaceIdx + ' X ' + priceDescription + extraSpacePrice +
                       price.toFixed(2) + '€';
           return value;
        }
    };

    cyclicView.init();

});