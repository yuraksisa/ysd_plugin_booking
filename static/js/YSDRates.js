define(function(){var a={};return a.Season=function(a,b,c){this.id=a,this.start=b,this.end=c,this.days=function(a,b){var c=a.getFullYear().toString(),d=this.start+"/"+c,e=this.end+"/"+c,f=new Date(d),g=new Date(e),h=(((b<g?b:g)-(a>f?a:f))/864e5+1).toFixed(0);return h}},a.Calendar=function(a){this.seasons=a,this.get_seasons_days=function(a,b){var c=[],d=0,e=a,f=b;this.checkToDate(f,b,h);var g=this.seasons.length,h=e.getFullYear();do{var i=this.seasons[d],j=i.days(e,f);j>0&&(e=new Date(i.end+"/"+h.toString()),c.push({season:i.id,days:j})),e<=b&&(d++,d==g&&(d=0,h++,e.setDate(1),e.setMonth(0),e.setYear(h),this.checkToDate(f,b,h)))}while(e<=b);return c},this.checkToDate=function(a,b,c){b.getFullYear()>c?(a.setDate(31),a.setMonth(11),a.setYear(c)):a=b}},a.FirstSeasonDayCalendar=function(a){this.seasons=a,this.get_seasons_days=function(a,b){var c=[],d=0,e=a,f=b;this.checkToDate(f,b,h);var g=this.seasons.length,h=e.getFullYear();do{var i=this.seasons[d],j=i.days(e,f);if(j>0){e=new Date(i.end+"/"+h.toString()),c.push({season:i.id,days:((b-a)/864e5+1).toFixed(0)});break}e<=b&&(d++,d==g&&(d=0,h++,e.setDate(1),e.setMonth(0),e.setYear(h),this.checkToDate(f,b,h)))}while(e<=b);return c}},a.FirstSeasonDayCalendar.prototype=new a.Calendar,a.FirstSeasonDayCalendar.constructor=a.FirstSeasonDayCalendar,a.Factor=function(a,b,c){this.from=a,this.to=b,this.factor=c,this.applies=function(c){return c>=a&&c<=b}},a.RateFinder=function(a){this.rates=a,this.get_rate=function(a,b){var c=a+b;return this.rates[c]?this.rates[c]:this.rates[a]}},a.OptionalRateFinder=function(a){this.optionRates=a,this.get_rate=function(a,b){return"undefined"!=typeof this.optionRates[b]?"undefined"!=typeof this.optionRates[b][a]?this.optionRates[b][a]:this.optionRates[b]:null}},a.FactorFinder=function(a){this.factors=a,this.get_factor=function(a,b,c){for(var d=1,e=0;e<this.factors.length;e++)if(this.factors[e].applies(c)){d=this.factors[e].factor;break}return d}},a.FixedFactorFinder=function(a){this.value=a,this.get_factor=function(a,b,c){return this.value}},a.FixedSeasonFactorFinder=function(a){this.value=a,this.get_factor=function(a,b,c){return this.value[a]}},a.SeasonFactorFinder=function(b,c){this.factors=b,this.globalFactors=c,this.get_factor=function(c,d,e){var f=null;c&&b[c]&&b[c][d]&&(f=this.factors[c][d]);var g=new a.FactorFinder(f||this.globalFactors);return g.get_factor(c,d,e)}},a.PriceCalculatorSimpleRate=function(a,b){return a.price*b},a.PriceCalculatorDaysRate=function(a,b){if(b<=a.upToDays)return a.prices[b];var c=b-a.upToDays;return a.prices[a.upToDays]+a.extraPrice*c},a.RateCalculation=function(b,c,d,e,f,g){this.calendar=b,this.rateFinder=c,this.factorFinder=d,this.optionalFinder=e,this.priceCalculationFunction=f||a.PriceCalculatorSimpleRate,this.basePrice=g,this.get_price=function(b,c,d,e,f){var g=((c-b)/864e5).toFixed(0),h=new Date(c);h.setDate(h.getDate()-1);var i=this.calendar.get_seasons_days(b,h),j=null;i.length>0&&(j=i[0].season);var l=(d.length,i.length),m={};for(var n in d){for(var o=this.rateFinder.get_rate(n,g),p=0,q=this.basePrice[n]||0,r=0;r<l;r++){var s=i[r].season;p+=d[n].detailedPrice?a.PriceCalculatorDaysRate(o[s],i[r].days):a.PriceCalculatorSimpleRate(o[s],i[r].days)}d[n].detailedPrice||null!=this.factorFinder&&(p*=this.factorFinder.get_factor(j,n,g)),p+=q,m[n]=new Number(p.toFixed(f));for(var t in e){var u=this.optionalFinder.get_rate(n,t),v=0;null!=u&&(v=u.price*g),m[n][t]=new Number((p+v).toFixed(f))}}return m}},a.Option=function(a,b,c,d){this.id=a,this.name=b,this.abbr=c,this.description=d},a.Extra=function(a,b,c,d,e,f,g){this.id=a,this.the_name=b,this.description=c,this.max_quantity=d,this.notAcceptedOptionals=e||[],this.detailedPrice=f,this.translations=g,this.optionalAccepted=function(a){return Array.prototype.indexOf?this.notAcceptedOptionals.indexOf(a)==-1:_.indexOf(this.notAcceptedOptionals,a)==-1}},a.ExtraCalculation=function(b,c){this.extrasRates=b,this.extras=c,this.get_extra_rate=function(a,b){var c=this.extrasRates[a];return c[b]?c[b]:c},this.get_price=function(b,c,d,e,f){var g=((c-b)/864e5).toFixed(0);if(g>0){var h=this.get_extra_rate(d,e),i=0;return i=this.extras[d].detailedPrice?a.PriceCalculatorDaysRate(h,g):a.PriceCalculatorSimpleRate(h,g),h.maxPrice>0?new Number(Math.min(i,h.maxPrice).toFixed(f)):new Number(i).toFixed(f)}return 0}},a});